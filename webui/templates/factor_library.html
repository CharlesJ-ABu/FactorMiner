{% extends "base.html" %}

{% block title %}å› å­åº“ - {{ config.title }}{% endblock %}

{% block content %}
<style>
@media (max-width: 768px) {
    .factor-library-card {
        height: auto !important;
        min-height: 400px;
    }
    .factor-library-card .card-body {
        max-height: none !important;
    }
}
/* å› å­åˆ—è¡¨è¡¨æ ¼æ•´ä½“å±…ä¸­ */
#factorList table th,
#factorList table td {
    text-align: center;
    vertical-align: middle;
}
.sort-icon { margin-left: 4px; font-size: 0.85em; }
</style>
<!-- noUiSlider æ ·å¼ä¸è„šæœ¬ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css">
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<div class="row">
    <div class="col-12">
        <h2>ğŸ“š å› å­åº“</h2>
        <p class="text-muted">ç®¡ç†å’ŒæŸ¥çœ‹æ‰€æœ‰å·²æŒ–æ˜çš„å› å­ï¼Œä½¿ç”¨è¡Œæƒ…æ•°æ®è¿›è¡Œè¯„ä¼°å’Œåˆ†æ</p>
    </div>
</div>

<div class="row" style="min-height: 500px;">
    <!-- å·¦ä¾§ï¼šå› å­åˆ†ç±»å’Œç­›é€‰ -->
    <div class="col-lg-2 col-md-3 col-sm-12 mb-3">
        <div class="card factor-library-card" style="height: 500px;">
            <div class="card-header">
                <h6 class="mb-0">ğŸ” ç­›é€‰</h6>
            </div>
            <div class="card-body" style="overflow-y: auto; max-height: 400px;">
                <form id="factorFilterForm">
                    <!-- å› å­ç±»å‹ç­›é€‰ -->
                    <div class="mb-3">
                        <label class="form-label small">å› å­ç±»å‹</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="typeAlpha101" checked>
                            <label class="form-check-label small" for="typeAlpha101">Alpha101</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="typeML" checked>
                            <label class="form-check-label small" for="typeML">MLå› å­</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="typeTraditional" checked>
                            <label class="form-check-label small" for="typeTraditional">ä¼ ç»Ÿå› å­</label>
                        </div>
                    </div>
                    
                    <!-- è¯„ä¼°çŠ¶æ€ç­›é€‰ -->
                    <div class="mb-3">
                        <label class="form-label small">è¯„ä¼°çŠ¶æ€</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="statusEvaluated" checked>
                            <label class="form-check-label small" for="statusEvaluated">å·²è¯„ä¼°</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="statusUnevaluated" checked>
                            <label class="form-check-label small" for="statusUnevaluated">æœªè¯„ä¼°</label>
                        </div>
                    </div>
                    
                    <!-- æ€§èƒ½ç­›é€‰ -->
                    <div class="mb-3">
                        <label class="form-label small">æ€§èƒ½ç­›é€‰</label>
                        <select class="form-select form-select-sm" id="performanceFilter">
                            <option value="">å…¨éƒ¨</option>
                            <option value="high">é«˜ç»©æ•ˆ (IC > 0.05)</option>
                            <option value="medium">ä¸­ç­‰ç»©æ•ˆ (0.02 < IC < 0.05)</option>
                            <option value="low">ä½ç»©æ•ˆ (IC < 0.02)</option>
                        </select>
                    </div>
                    
                    <!-- æœç´¢æ¡† -->
                    <div class="mb-3">
                        <label class="form-label small">æœç´¢</label>
                        <input type="text" class="form-control form-control-sm" id="factorSearch" placeholder="å› å­åç§°...">
                    </div>
                    
                    <button type="button" class="btn btn-primary btn-sm w-100" onclick="applyFilters()">åº”ç”¨ç­›é€‰</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ä¸­é—´ï¼šå› å­åˆ—è¡¨ -->
    <div class="col-lg-10 col-md-9 col-sm-12 mb-3">
        <div class="card factor-library-card" style="height: 500px;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">ğŸ“‹ å› å­åˆ—è¡¨</h6>
                <div>
                    <span class="badge bg-primary" id="factorCount">0</span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="refreshFactorList()">åˆ·æ–°</button>
                </div>
            </div>
            <div class="card-body" style="overflow-y: auto; max-height: 400px;">
                <div id="factorList">
                    <div class="text-center text-muted">
                        <p>æ­£åœ¨åŠ è½½å› å­åˆ—è¡¨...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å› å­è¯¦æƒ…åŒºåŸŸï¼ˆé€‰æ‹©å³æ˜¾ç¤ºï¼‰ -->
<div class="row mb-3">
    <!-- å› å­è¯¦æƒ…å’Œè¯„ä¼°åˆ†åŒº -->
    <div class="col-12" id="factorDetailsSection" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ğŸ“Š å› å­è¯¦æƒ…ä¸è¯„ä¼°</h5>
            </div>
            <div class="card-body">
                <!-- ç›´æ¥å±•ç¤ºæ‰€æœ‰è¯¦æƒ…åˆ†åŒºï¼Œæ— æ ‡ç­¾åˆ‡æ¢ -->
                <div class="mt-2" id="factorDetailsContent"></div>
                <hr/>
                <div class="mt-2" id="factorFormulaContent"></div>
                <hr/>
                <div class="mt-2" id="factorEvaluationContent"></div>
                <hr/>
                <div class="mt-2" id="factorPerformanceContent"></div>
                <hr/>
                <div class="mt-2" id="factorHistoryContent"></div>
                        </div>
                    </div>
                        </div>
                    </div>
                    






<script>
let currentFactors = [];
let selectedFactor = null;
let sortField = 'name';
let sortAsc = true;

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async function() {
    loadFactorList();
    // ä¸è‡ªåŠ¨åŠ è½½äº¤æ˜“å¯¹å’Œæ—¶é—´æ¡†æ¶ï¼Œç­‰ç”¨æˆ·é€‰æ‹©äº¤æ˜“æ‰€å’Œäº¤æ˜“ç±»å‹åå†åŠ è½½
});

// äº¤æ˜“æ‰€å˜åŒ–å¤„ç†
function onExchangeChange() {
    const tradeType = document.getElementById('evaluationTradeType').value;
    if (tradeType) {
        loadSymbols();
        // æ¸…ç©ºå¹¶ç¦ç”¨æ—¶é—´æ¡†æ¶ï¼Œå¾…é€‰æ‹©å¸å¯¹åå†å¡«å……
        const tfSelect = document.getElementById('evaluationTimeframe');
        tfSelect.innerHTML = '<option value="">å…ˆé€‰æ‹©äº¤æ˜“å¯¹</option>';
        tfSelect.disabled = true;
        hideDateSlider();
    }
}

// äº¤æ˜“ç±»å‹å˜åŒ–å¤„ç†
function onTradeTypeChange() {
    const exchange = document.getElementById('evaluationExchange').value;
    if (exchange) {
        loadSymbols();
        // æ¸…ç©ºå¹¶ç¦ç”¨æ—¶é—´æ¡†æ¶ï¼Œå¾…é€‰æ‹©å¸å¯¹åå†å¡«å……
        const tfSelect = document.getElementById('evaluationTimeframe');
        tfSelect.innerHTML = '<option value="">å…ˆé€‰æ‹©äº¤æ˜“å¯¹</option>';
        tfSelect.disabled = true;
        hideDateSlider();
    }
}

// åŠ è½½å› å­åˆ—è¡¨
async function loadFactorList() {
    try {
        const response = await fetch('/api/factors/list');
        const data = await response.json();
        
        if (data.success) {
            currentFactors = data.factors;
            displayFactorList(currentFactors);
            updateFactorCount();
        } else {
            showError('åŠ è½½å› å­åˆ—è¡¨å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        showError('åŠ è½½å› å­åˆ—è¡¨å¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤ºå› å­åˆ—è¡¨
function displayFactorList(factors) {
    const container = document.getElementById('factorList');
    
    if (!Array.isArray(factors) || factors.length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><p>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å› å­</p></div>';
        return;
    }
    
    // æ’åº
    const sorted = [...factors].sort((a, b) => {
        const av = getSortValue(a, sortField);
        const bv = getSortValue(b, sortField);
        if (av === bv) return 0;
        if (av === null || av === undefined) return sortAsc ? 1 : -1;
        if (bv === null || bv === undefined) return sortAsc ? -1 : 1;
        if (typeof av === 'number' && typeof bv === 'number') {
            return sortAsc ? (av - bv) : (bv - av);
        }
        return sortAsc ? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av));
    });

    const header = `
        <table class="table table-sm align-middle text-center">
            <thead>
                <tr>
                    <th style="width: 22%; cursor: pointer;" onclick="sortBy('name')">åç§° ${getSortIcon('name')}</th>
                    <th style="width: 10%; cursor: pointer;" onclick="sortBy('type')">ç±»å‹ ${getSortIcon('type')}</th>
                    <th style="width: 10%; cursor: pointer;" onclick="sortBy('ic')">ICå‡å€¼ ${getSortIcon('ic')}</th>
                    <th style="width: 10%; cursor: pointer;" onclick="sortBy('rank_ic')">Rank ICå‡å€¼ ${getSortIcon('rank_ic')}</th>
                    <th style="width: 10%; cursor: pointer;" onclick="sortBy('icir')">ICIR ${getSortIcon('icir')}</th>
                    <th style="width: 10%; cursor: pointer;" onclick="sortBy('pos_ic_ratio')">æ­£ICå æ¯” ${getSortIcon('pos_ic_ratio')}</th>
                    <th style="width: 10%; cursor: pointer;" onclick="sortBy('long_short_return')">å¤šç©ºæ”¶ç›Š ${getSortIcon('long_short_return')}</th>
                    <th style="width: 10%; cursor: pointer;" onclick="sortBy('ir')">IRå‡å€¼ ${getSortIcon('ir')}</th>
                    <th style="width: 10%; cursor: pointer;" onclick="sortBy('win_rate')">èƒœç‡å‡å€¼ ${getSortIcon('win_rate')}</th>
                    <th style="width: 10%; cursor: pointer;" onclick="sortBy('evaluations_count')">è¯„ä¼°æ¬¡æ•° ${getSortIcon('evaluations_count')}</th>
                    <th style="width: 18%; cursor: pointer;" onclick="sortBy('last_evaluated_at')">æœ€è¿‘è¯„ä¼°æ—¶é—´ ${getSortIcon('last_evaluated_at')}</th>
                    <th style="width: 10%;">çŠ¶æ€</th>
                </tr>
            </thead>
            <tbody>
    `;

    const rows = sorted.map(f => {
        const ic = f.ic != null ? f.ic.toFixed(4) : '';
        const rank_ic = f.rank_ic != null ? f.rank_ic.toFixed(4) : '';
        const icir = f.icir != null ? f.icir.toFixed(4) : '';
        const pos_ic_ratio = f.pos_ic_ratio != null ? (f.pos_ic_ratio * 100).toFixed(1) + '%' : '';
        const lsr = f.long_short_return != null ? (f.long_short_return * 100).toFixed(2) + '%' : '';
        const ir = f.ir != null ? f.ir.toFixed(4) : '';
        const wr = f.avg_metrics && f.avg_metrics.win_rate != null ? (f.avg_metrics.win_rate * 100).toFixed(1) + '%' : '';
        const cnt = f.evaluations_count != null ? f.evaluations_count : 0;
        const last = f.last_evaluated_at ? f.last_evaluated_at : '';
        return `
            <tr class="factor-item" style="cursor: pointer;" onclick="selectFactor('${f.id}')">
                <td><div class="fw-semibold">${f.name}</div><div class="text-muted small">${f.description || ''}</div></td>
                <td><span class="badge bg-${getTypeBadgeColor(f.type)}">${f.type}</span></td>
                <td class="text-${f.ic != null ? getICColor(f.ic) : 'muted'}">${ic}</td>
                <td>${rank_ic}</td>
                <td>${icir}</td>
                <td>${pos_ic_ratio}</td>
                <td>${lsr}</td>
                <td>${ir}</td>
                <td>${wr}</td>
                <td>${cnt}</td>
                <td class="small text-muted">${last}</td>
                <td>${f.evaluated ? '<span class="badge bg-success">å·²è¯„ä¼°</span>' : '<span class="badge bg-warning">æœªè¯„ä¼°</span>'}</td>
            </tr>
        `;
    }).join('');

    const footer = `</tbody></table>`;
    container.innerHTML = header + rows + footer;
}

function sortBy(field) {
    if (sortField === field) {
        sortAsc = !sortAsc;
    } else {
        sortField = field;
        sortAsc = true;
    }
    displayFactorList(currentFactors);
    updateFactorCount();
}

function getSortValue(f, field) {
    switch (field) {
        case 'name': return f.name || '';
        case 'type': return f.type || '';
        case 'ic': return f.ic != null ? f.ic : -Infinity;
        case 'rank_ic': return f.rank_ic != null ? f.rank_ic : -Infinity;
        case 'icir': return f.icir != null ? f.icir : -Infinity;
        case 'pos_ic_ratio': return f.pos_ic_ratio != null ? f.pos_ic_ratio : -Infinity;
        case 'long_short_return': return f.long_short_return != null ? f.long_short_return : -Infinity;
        case 'ir': return f.ir != null ? f.ir : -Infinity;
        case 'win_rate': return f.avg_metrics && f.avg_metrics.win_rate != null ? f.avg_metrics.win_rate : -Infinity;
        case 'evaluations_count': return f.evaluations_count || 0;
        case 'last_evaluated_at': return f.last_evaluated_at || '';
        default: return '';
    }
}

function getSortIcon(field) {
    if (sortField !== field) return '';
    return `<span class="sort-icon">${sortAsc ? 'â–²' : 'â–¼'}</span>`;
}

// é€‰æ‹©å› å­
function selectFactor(factorId) {
    selectedFactor = currentFactors.find(f => f.id === factorId);
    // æ›´æ–°é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.factor-item').forEach(item => {
        item.classList.remove('border-primary');
    });
    event.currentTarget.classList.add('border-primary');
    
    // ç›´æ¥æ˜¾ç¤ºè¯¦æƒ…åˆ†åŒºå¹¶åŠ è½½å†…å®¹
    document.getElementById('factorDetailsSection').style.display = 'block';
    loadFactorDetails();
    loadFactorFormula();
    loadFactorEvaluation().then(() => {
        loadFactorPerformance();
        loadFactorHistory();
    });
    document.getElementById('factorDetailsSection').scrollIntoView({ behavior: 'smooth' });
}

// æ˜¾ç¤ºå› å­è¯¦æƒ…
function displayFactorDetails(factor) {
    const container = document.getElementById('factorDetailsContent');
    
    const html = `
        <div class="row">
            <div class="col-md-8">
                <div class="mb-3">
                    <h5>${factor.name}</h5>
                    <p class="text-muted">${factor.description}</p>
                </div>
                
                <div class="mb-3">
                    <h6>åŸºæœ¬ä¿¡æ¯</h6>
                    <table class="table table-sm">
                        <tr><td>ç±»å‹</td><td><span class="badge bg-${getTypeBadgeColor(factor.type)}">${factor.type}</span></td></tr>
                        <tr><td>åˆ›å»ºæ—¶é—´</td><td>${factor.created_at}</td></tr>
                        <tr><td>çŠ¶æ€</td><td>${factor.evaluated ? '<span class="badge bg-success">å·²è¯„ä¼°</span>' : '<span class="badge bg-warning">æœªè¯„ä¼°</span>'}</td></tr>
                        <tr><td>æ–‡ä»¶è·¯å¾„</td><td><code class="small">${factor.file_path}</code></td></tr>
                    </table>
                </div>
                
                ${factor.evaluated ? `
                <div class="mb-3">
                    <h6>è¯„ä¼°ç»“æœ</h6>
                    <table class="table table-sm">
                        ${factor.ic ? `<tr><td>IC</td><td class="text-${getICColor(factor.ic)}">${factor.ic.toFixed(4)}</td></tr>` : ''}
                        ${factor.ir ? `<tr><td>IR</td><td>${factor.ir.toFixed(4)}</td></tr>` : ''}
                        ${factor.win_rate ? `<tr><td>èƒœç‡</td><td>${(factor.win_rate * 100).toFixed(2)}%</td></tr>` : ''}
                        ${factor.sharpe ? `<tr><td>å¤æ™®æ¯”ç‡</td><td>${factor.sharpe.toFixed(4)}</td></tr>` : ''}
                    </table>
                </div>
                ` : ''}
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ğŸ“Š æ€§èƒ½æ¦‚è§ˆ</h6>
                    </div>
                    <div class="card-body">
                        ${factor.ic ? `
                        <div class="mb-2">
                            <small class="text-muted">ä¿¡æ¯ç³»æ•° (IC)</small>
                            <div class="h5 text-${getICColor(factor.ic)}">${factor.ic.toFixed(4)}</div>
                        </div>
                        ` : ''}
                        ${factor.ir ? `
                        <div class="mb-2">
                            <small class="text-muted">ä¿¡æ¯æ¯”ç‡ (IR)</small>
                            <div class="h5">${factor.ir.toFixed(4)}</div>
                        </div>
                        ` : ''}
                        ${factor.win_rate ? `
                        <div class="mb-2">
                            <small class="text-muted">èƒœç‡</small>
                            <div class="h5">${(factor.win_rate * 100).toFixed(1)}%</div>
                        </div>
                        ` : ''}
                        ${factor.sharpe ? `
                        <div class="mb-2">
                            <small class="text-muted">å¤æ™®æ¯”ç‡</small>
                            <div class="h5">${factor.sharpe.toFixed(4)}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// åº”ç”¨ç­›é€‰
function applyFilters() {
    const typeAlpha101 = document.getElementById('typeAlpha101').checked;
    const typeML = document.getElementById('typeML').checked;
    const typeTraditional = document.getElementById('typeTraditional').checked;
    const statusEvaluated = document.getElementById('statusEvaluated').checked;
    const statusUnevaluated = document.getElementById('statusUnevaluated').checked;
    const performanceFilter = document.getElementById('performanceFilter').value;
    const searchTerm = document.getElementById('factorSearch').value.toLowerCase();
    
    let filteredFactors = currentFactors.filter(factor => {
        // ç±»å‹ç­›é€‰
        const typeMatch = (factor.type === 'Alpha101' && typeAlpha101) ||
                         (factor.type === 'ML' && typeML) ||
                         (factor.type === 'Traditional' && typeTraditional);
        
        // çŠ¶æ€ç­›é€‰
        const statusMatch = (factor.evaluated && statusEvaluated) ||
                           (!factor.evaluated && statusUnevaluated);
        
        // æœç´¢ç­›é€‰
        const searchMatch = !searchTerm || 
                           factor.name.toLowerCase().includes(searchTerm) ||
                           factor.description.toLowerCase().includes(searchTerm);
        
        // æ€§èƒ½ç­›é€‰
        let performanceMatch = true;
        if (performanceFilter && factor.ic) {
            if (performanceFilter === 'high') performanceMatch = factor.ic > 0.05;
            else if (performanceFilter === 'medium') performanceMatch = factor.ic >= 0.02 && factor.ic <= 0.05;
            else if (performanceFilter === 'low') performanceMatch = factor.ic < 0.02;
        }
        
        return typeMatch && statusMatch && searchMatch && performanceMatch;
    });
    
    displayFactorList(filteredFactors);
    updateFactorCount();
}

// æ›´æ–°å› å­æ•°é‡
function updateFactorCount() {
    const count = document.querySelectorAll('#factorList tbody tr.factor-item').length;
    document.getElementById('factorCount').textContent = count;
}

// ç§»é™¤æ—§çš„åŸºäºé™æ€ç«¯ç‚¹çš„åŠ è½½é€»è¾‘ï¼Œæ”¹ä¸ºåŸºäºæœ¬åœ°æ•°æ®è¿‡æ»¤

// æ‰“å¼€è¯„ä¼°æ¨¡æ€æ¡†
function openEvaluationModal() {
    if (!selectedFactor) {
        showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå› å­');
        return;
    }
    
    // è®¾ç½®é»˜è®¤æ—¥æœŸ
    const today = new Date();
    const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
    
    document.getElementById('evaluationStartDate').value = oneYearAgo.toISOString().split('T')[0];
    document.getElementById('evaluationEndDate').value = today.toISOString().split('T')[0];
    
    const modal = new bootstrap.Modal(document.getElementById('evaluationModal'));
    modal.show();
}





// æ˜¾ç¤ºå› å­è¯¦æƒ…åˆ†åŒº
async function showFactorDetails() {
    if (!selectedFactor) {
        showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå› å­');
        return;
    }
    
    // æ˜¾ç¤ºè¯¦æƒ…åˆ†åŒº
    document.getElementById('factorDetailsSection').style.display = 'block';
    
    // åŠ è½½æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
    loadFactorDetails();
    loadFactorFormula();
    await loadFactorEvaluation();
    loadFactorPerformance();
    
    // æ»šåŠ¨åˆ°è¯¦æƒ…åˆ†åŒº
    document.getElementById('factorDetailsSection').scrollIntoView({ 
        behavior: 'smooth' 
    });
}



// åŠ è½½å› å­è¯¦æƒ…
function loadFactorDetails() {
    const container = document.getElementById('factorDetailsContent');
    
    const html = `
        <!-- å› å­åŸºæœ¬ä¿¡æ¯ -->
        <div class="mb-4">
            <h4 class="mb-2">${selectedFactor.name}</h4>
            <p class="text-muted mb-3">${selectedFactor.description}</p>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="d-flex align-items-center mb-2">
                        <span class="text-muted me-2">ç±»å‹:</span>
                        <span class="badge bg-${getTypeBadgeColor(selectedFactor.type)}">${selectedFactor.type}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center mb-2">
                        <span class="text-muted me-2">çŠ¶æ€:</span>
                        ${selectedFactor.evaluated ? 
                            '<span class="badge bg-success">å·²è¯„ä¼°</span>' : 
                            '<span class="badge bg-warning">æœªè¯„ä¼°</span>'
                        }
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                        <span class="text-muted me-2">åˆ›å»ºæ—¶é—´:</span>
                        <span>${selectedFactor.created_at}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¯„ä¼°ç»“æœ -->
        ${selectedFactor.evaluated ? `
        <div class="mb-4">
            <h5 class="mb-3">ğŸ“Š è¯„ä¼°ç»“æœ</h5>
            <div class="row">
                ${selectedFactor.ic ? `
                <div class="col-md-3 mb-3">
                    <div class="border rounded p-3 text-center">
                        <div class="text-muted small mb-1">ä¿¡æ¯ç³»æ•° (IC)</div>
                        <div class="h4 text-${getICColor(selectedFactor.ic)}">${selectedFactor.ic.toFixed(4)}</div>
                    </div>
                </div>
                ` : ''}
                ${selectedFactor.ir ? `
                <div class="col-md-3 mb-3">
                    <div class="border rounded p-3 text-center">
                        <div class="text-muted small mb-1">ä¿¡æ¯æ¯”ç‡ (IR)</div>
                        <div class="h4">${selectedFactor.ir.toFixed(4)}</div>
                    </div>
                </div>
                ` : ''}
                ${selectedFactor.win_rate ? `
                <div class="col-md-3 mb-3">
                    <div class="border rounded p-3 text-center">
                        <div class="text-muted small mb-1">èƒœç‡</div>
                        <div class="h4">${(selectedFactor.win_rate * 100).toFixed(1)}%</div>
                    </div>
                </div>
                ` : ''}
                ${selectedFactor.sharpe ? `
                <div class="col-md-3 mb-3">
                    <div class="border rounded p-3 text-center">
                        <div class="text-muted small mb-1">å¤æ™®æ¯”ç‡</div>
                        <div class="h4">${selectedFactor.sharpe.toFixed(4)}</div>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
        ` : `
        <div class="alert alert-info">
            <p class="mb-0">è¯¥å› å­å°šæœªè¯„ä¼°ï¼Œè¯·å…ˆè¿›è¡Œè¯„ä¼°ä»¥æŸ¥çœ‹è¯¦ç»†ç»“æœã€‚</p>
        </div>
        `}
        
        <!-- æ–‡ä»¶ä¿¡æ¯ -->
        <div class="mb-3">
            <h6 class="text-muted">æ–‡ä»¶è·¯å¾„</h6>
            <code class="bg-light p-2 rounded d-block">${selectedFactor.file_path}</code>
        </div>
    `;
    
    container.innerHTML = html;
}

// åŠ è½½å› å­å…¬å¼
function loadFactorFormula() {
    const container = document.getElementById('factorFormulaContent');
    
    const html = `
        <div class="mb-4">
            <h4 class="mb-2">${selectedFactor.name}</h4>
            <p class="text-muted mb-3">${selectedFactor.description}</p>
        </div>
        
        <div class="mb-4">
            <h5 class="mb-3">ğŸ“ å› å­å…¬å¼</h5>
            <div class="border rounded p-4 bg-light">
                <pre class="mb-0"><code>${selectedFactor.formula || 'æš‚æ— å…¬å¼'}</code></pre>
            </div>
        </div>
        
        ${selectedFactor.formula ? `
        <div class="mb-3">
            <h6 class="text-muted">å…¬å¼è¯´æ˜</h6>
            <p class="text-muted">
                è¿™æ˜¯ä¸€ä¸ª${selectedFactor.type}ç±»å‹çš„å› å­ï¼Œä½¿ç”¨æ•°å­¦å…¬å¼è®¡ç®—å¾—å‡ºã€‚
                å…¬å¼ä¸­çš„å˜é‡åŒ…æ‹¬ä»·æ ¼ã€æˆäº¤é‡ç­‰å¸‚åœºæ•°æ®ã€‚
            </p>
        </div>
        ` : ''}
    `;
    
    container.innerHTML = html;
}

// åŠ è½½å› å­è¯„ä¼°
async function loadFactorEvaluation() {
    const container = document.getElementById('factorEvaluationContent');
    
    const html = `
        <div class="mb-3">
            <h6>è¯„ä¼°é…ç½®</h6>
            <p class="text-muted small">é…ç½®å› å­è¯„ä¼°çš„å‚æ•°</p>
        </div>
        
        <form id="evaluationForm">
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">äº¤æ˜“æ‰€</label>
                        <select class="form-select" id="evaluationExchange" required onchange="onExchangeChange()">
                            <option value="">é€‰æ‹©äº¤æ˜“æ‰€</option>
                            <option value="binance">Binance</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">äº¤æ˜“ç±»å‹</label>
                        <select class="form-select" id="evaluationTradeType" required onchange="onTradeTypeChange()">
                            <option value="">é€‰æ‹©ç±»å‹</option>
                            <option value="futures">æœŸè´§</option>
                            <option value="spot">ç°è´§</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">äº¤æ˜“å¯¹</label>
                        <select class="form-select" id="evaluationSymbol" required disabled onchange="onSymbolChange()">
                            <option value="">å…ˆé€‰æ‹©äº¤æ˜“æ‰€å’Œç±»å‹</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">æ—¶é—´æ¡†æ¶</label>
                        <select class="form-select" id="evaluationTimeframe" required disabled onchange="onTimeframeChange()">
                            <option value="">å…ˆé€‰æ‹©äº¤æ˜“æ‰€å’Œç±»å‹</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- ç”±æ»‘æ¡æ§åˆ¶çš„æ—¥æœŸèŒƒå›´ï¼Œç§»é™¤æ‰‹åŠ¨è¾“å…¥æ¡†ï¼Œä»…ä¿ç•™éšè—å­—æ®µç”¨äºæäº¤ -->
            <input type="hidden" id="evaluationStartDate">
            <input type="hidden" id="evaluationEndDate">

            <!-- æ—¶é—´èŒƒå›´æ»‘æ¡ï¼ˆnoUiSlider åŒç«¯èŒƒå›´ï¼‰ -->
            <div class="mb-3" id="dateRangeSliderContainer" style="display: none;">
                <label class="form-label">æ•°æ®æ—¶é—´èŒƒå›´</label>
                <div class="text-muted small mb-2" id="dateRangeInfo">â€”</div>
                <div id="dateRangeSlider"></div>
                <div class="d-flex justify-content-between small text-muted mt-2">
                    <span id="dateSliderStartLabel">å¼€å§‹</span>
                    <span id="dateSliderEndLabel">ç»“æŸ</span>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">è¯„ä¼°æŒ‡æ ‡</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="metricIC" checked>
                    <label class="form-check-label" for="metricIC">ä¿¡æ¯ç³»æ•° (IC)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="metricIR" checked>
                    <label class="form-check-label" for="metricIR">ä¿¡æ¯æ¯”ç‡ (IR)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="metricWinRate" checked>
                    <label class="form-check-label" for="metricWinRate">èƒœç‡</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="metricSharpe" checked>
                    <label class="form-check-label" for="metricSharpe">å¤æ™®æ¯”ç‡</label>
                </div>
            </div>
        </form>
        
        <!-- å¼€å§‹è¯„ä¼°æŒ‰é’® -->
        <div class="d-flex justify-content-center mt-4">
            <button class="btn btn-success btn-lg" onclick="startEvaluation()">
                ğŸš€ å¼€å§‹è¯„ä¼°
            </button>
        </div>
        
        <div id="evaluationProgress" style="display: none;">
            <div class="progress mb-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>
            <p id="evaluationStatus" class="text-muted">å‡†å¤‡è¯„ä¼°...</p>
        </div>
        
        <!-- è¯„ä¼°ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div id="evaluationResults" style="display: none;" class="mt-4">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ğŸ“Š è¯„ä¼°ç»“æœ</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="scrollToTop()">å›åˆ°é¡¶éƒ¨ â¤´</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="evaluationResultsContent">
                        <!-- è¯„ä¼°ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <div class="mt-3" id="evaluationChartsContainer" style="display:none;">
                        <canvas id="evaluationBarChart" height="120"></canvas>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // åŠ è½½äº¤æ˜“å¯¹å’Œæ—¶é—´æ¡†æ¶
    await loadSymbols();
    await loadTimeframes();
}

// åŠ è½½æ€§èƒ½åˆ†æ
function loadFactorPerformance() {
    const container = document.getElementById('factorPerformanceContent');
    
    const html = `
        <div class="mb-4">
            <h4 class="mb-2">${selectedFactor.name}</h4>
            <p class="text-muted mb-3">æ€§èƒ½åˆ†æ - åˆ†æå› å­çš„å†å²è¡¨ç°</p>
        </div>
        
        ${selectedFactor.evaluated ? `
        <div class="mb-4">
            <h5 class="mb-3">ğŸ“Š æ€§èƒ½æŒ‡æ ‡</h5>
            <div class="row">
                ${selectedFactor.ic ? `
                <div class="col-md-3 mb-3">
                    <div class="border rounded p-3 text-center">
                        <div class="text-muted small mb-1">ä¿¡æ¯ç³»æ•° (IC)</div>
                        <div class="h4 text-${getICColor(selectedFactor.ic)}">${selectedFactor.ic.toFixed(4)}</div>
                    </div>
                </div>
                ` : ''}
                ${selectedFactor.ir ? `
                <div class="col-md-3 mb-3">
                    <div class="border rounded p-3 text-center">
                        <div class="text-muted small mb-1">ä¿¡æ¯æ¯”ç‡ (IR)</div>
                        <div class="h4">${selectedFactor.ir.toFixed(4)}</div>
                    </div>
                </div>
                ` : ''}
                ${selectedFactor.win_rate ? `
                <div class="col-md-3 mb-3">
                    <div class="border rounded p-3 text-center">
                        <div class="text-muted small mb-1">èƒœç‡</div>
                        <div class="h4">${(selectedFactor.win_rate * 100).toFixed(1)}%</div>
                    </div>
                </div>
                ` : ''}
                ${selectedFactor.sharpe ? `
                <div class="col-md-3 mb-3">
                    <div class="border rounded p-3 text-center">
                        <div class="text-muted small mb-1">å¤æ™®æ¯”ç‡</div>
                        <div class="h4">${selectedFactor.sharpe.toFixed(4)}</div>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
        ` : `
        <div class="alert alert-info">
            <p class="mb-0">è¯¥å› å­å°šæœªè¯„ä¼°ï¼Œè¯·å…ˆè¿›è¡Œè¯„ä¼°ä»¥æŸ¥çœ‹æ€§èƒ½åˆ†æã€‚</p>
        </div>
        `}
    `;
    
    container.innerHTML = html;
}

// åŠ è½½å†å²è¯„ä¼°ä¸å¯¹æ¯”
async function loadFactorHistory() {
    const container = document.getElementById('factorHistoryContent');
    container.innerHTML = '<div class="text-muted">æ­£åœ¨åŠ è½½å†å²è¯„ä¼°...</div>';
    try {
        const res = await fetch(`/api/factors/evaluations/${selectedFactor.id}`);
        const data = await res.json();
        if (!data.success) {
            container.innerHTML = `<div class="text-danger">åŠ è½½å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
            return;
        }
        const evaluations = data.evaluations || [];
        if (evaluations.length === 0) {
            container.innerHTML = '<div class="text-muted">æš‚æ— å†å²è¯„ä¼°è®°å½•</div>';
            return;
        }

        // è¡¨æ ¼ä¸å¯¹æ¯”å‹¾é€‰
        let html = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">ğŸ•’ å†å²è¯„ä¼°</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="renderHistoryComparison()">ç”Ÿæˆå¯¹æ¯”å›¾</button>
            </div>
            <div class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead>
                        <tr>
                            <th>å¯¹æ¯”</th>
                            <th>è¯„ä¼°æ—¶é—´</th>
                            <th>äº¤æ˜“å¯¹</th>
                            <th>æ—¶é—´æ¡†æ¶</th>
                            <th>åŒºé—´</th>
                            <th>IC</th>
                            <th>ç­‰çº§IC</th>
                            <th>èƒœç‡</th>
                            <th>å¤æ™®</th>
                            <th>å¤šç©ºæ”¶ç›Š</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${evaluations.map((ev, idx) => {
                            const m = ev.metadata || {};
                            const r = ev.results || {};
                            return `
                                <tr>
                                    <td><input type="checkbox" class="form-check-input" name="historyCompare" value="${idx}"></td>
                                    <td>${ev.evaluated_at || ''}</td>
                                    <td>${m.symbol || ''}</td>
                                    <td>${m.timeframe || ''}</td>
                                    <td>${(m.start_date || '')} ~ ${(m.end_date || '')}</td>
                                    <td>${numFmt(r.ic_pearson)}</td>
                                    <td>${numFmt(r.ic_spearman)}</td>
                                    <td>${pctFmt(r.win_rate)}</td>
                                    <td>${numFmt(r.sharpe_ratio)}</td>
                                    <td>${pctFmt(r.long_short_return)}</td>
                                </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div class="mt-3" id="historyChartsContainer" style="display:none;">
                <canvas id="historyComparisonChart" height="140"></canvas>
            </div>
        `;
        container.innerHTML = html;
        // æš‚å­˜åˆ°å…¨å±€ä»¥ä¾¿å¯¹æ¯”æ¸²æŸ“ä½¿ç”¨
        window.__factorHistoryEvaluations = evaluations;
    } catch (e) {
        container.innerHTML = `<div class="text-danger">åŠ è½½å¤±è´¥ï¼š${e.message}</div>`;
    }
}

function numFmt(v) {
    return (v === undefined || v === null) ? '' : Number(v).toFixed(4);
}
function pctFmt(v) {
    return (v === undefined || v === null) ? '' : (Number(v) * 100).toFixed(2) + '%';
}

function renderHistoryComparison() {
    const evaluations = window.__factorHistoryEvaluations || [];
    const checked = Array.from(document.querySelectorAll('input[name="historyCompare"]:checked')).map(el => parseInt(el.value, 10));
    if (checked.length === 0) {
        showError('è¯·è‡³å°‘å‹¾é€‰ä¸€æ¡å†å²è¯„ä¼°è¿›è¡Œå¯¹æ¯”');
        return;
    }
    const selected = checked.map(i => evaluations[i]);
    const labels = selected.map(ev => {
        const m = ev.metadata || {};
        return `${m.symbol || ''}-${m.timeframe || ''}`;
    });
    const ic = selected.map(ev => (ev.results || {}).ic_pearson || 0);
    const ic_s = selected.map(ev => (ev.results || {}).ic_spearman || 0);
    const win = selected.map(ev => (ev.results || {}).win_rate || 0);
    const sharp = selected.map(ev => (ev.results || {}).sharpe_ratio || 0);
    const lsr = selected.map(ev => (ev.results || {}).long_short_return || 0);

    const container = document.getElementById('historyChartsContainer');
    const canvas = document.getElementById('historyComparisonChart');
    container.style.display = 'block';
    if (canvas._chartInstance) canvas._chartInstance.destroy();

    const data = {
        labels,
        datasets: [
            { label: 'IC', data: ic, backgroundColor: 'rgba(75, 192, 192, 0.5)' },
            { label: 'ç­‰çº§IC', data: ic_s, backgroundColor: 'rgba(153, 102, 255, 0.5)' },
            { label: 'èƒœç‡', data: win, backgroundColor: 'rgba(255, 205, 86, 0.5)' },
            { label: 'å¤æ™®', data: sharp, backgroundColor: 'rgba(255, 99, 132, 0.5)' },
            { label: 'å¤šç©ºæ”¶ç›Š', data: lsr, backgroundColor: 'rgba(54, 162, 235, 0.5)' },
        ]
    };
    const options = { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } };
    canvas._chartInstance = new Chart(canvas.getContext('2d'), { type: 'bar', data, options });
}

// æŸ¥çœ‹å› å­å…¬å¼ï¼ˆæ»šåŠ¨åˆ°å…¬å¼åŒºåŸŸï¼‰
async function viewFactorFormula() {
    if (!selectedFactor) {
        showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå› å­');
        return;
    }
    
    // æ˜¾ç¤ºè¯¦æƒ…åˆ†åŒº
    document.getElementById('factorDetailsSection').style.display = 'block';
    
    // åŠ è½½æ‰€æœ‰å†…å®¹
    loadFactorDetails();
    loadFactorFormula();
    await loadFactorEvaluation();
    loadFactorPerformance();
    
    // æ»šåŠ¨åˆ°å…¬å¼åˆ†åŒº
    const el = document.getElementById('factorFormulaContent');
    if (el) {
        el.scrollIntoView({ behavior: 'smooth' });
    } else {
        document.getElementById('factorDetailsSection').scrollIntoView({ behavior: 'smooth' });
    }
}

// å¼€å§‹è¯„ä¼°
function startEvaluation() {
    if (!selectedFactor) {
        showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå› å­');
        return;
    }
    
    // è·å–è¯„ä¼°å‚æ•°
    const exchange = document.getElementById('evaluationExchange').value;
    const tradeType = document.getElementById('evaluationTradeType').value;
    const symbol = document.getElementById('evaluationSymbol').value;
    const timeframe = document.getElementById('evaluationTimeframe').value;
    const startDate = document.getElementById('evaluationStartDate').value;
    const endDate = document.getElementById('evaluationEndDate').value;
    
    if (!exchange || !tradeType || !symbol || !timeframe || !startDate || !endDate) {
        showError('è¯·å¡«å†™å®Œæ•´çš„è¯„ä¼°å‚æ•°');
        return;
    }
    

    
    // è·å–é€‰ä¸­çš„è¯„ä¼°æŒ‡æ ‡
    const metrics = [];
    if (document.getElementById('metricIC').checked) metrics.push('ic');
    if (document.getElementById('metricIR').checked) metrics.push('ir');
    if (document.getElementById('metricWinRate').checked) metrics.push('win_rate');
    if (document.getElementById('metricSharpe').checked) metrics.push('sharpe');
    
    if (metrics.length === 0) {
        showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¯„ä¼°æŒ‡æ ‡');
        return;
    }
    
    // æ˜¾ç¤ºè¯„ä¼°è¿›åº¦
    const progressDiv = document.getElementById('evaluationProgress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    const statusText = document.getElementById('evaluationStatus');
    
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    statusText.textContent = 'å¼€å§‹è¯„ä¼°...';
    
    // å‘é€è¯„ä¼°è¯·æ±‚
    fetch('/api/factors/evaluate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            factor_id: selectedFactor.id,
            exchange: exchange,
            trade_type: tradeType,
            symbol: symbol,
            timeframe: timeframe,
            start_date: startDate,
            end_date: endDate,
            metrics: metrics
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            progressBar.style.width = '100%';
            statusText.textContent = 'è¯„ä¼°å®Œæˆï¼';
            showSuccess('å› å­è¯„ä¼°å®Œæˆ');
            
            // æ˜¾ç¤ºè¯„ä¼°ç»“æœ
            displayEvaluationResults(data.results);
            
            // åˆ·æ–°å› å­åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°çš„è¯„ä¼°ç»“æœ
            setTimeout(() => {
                loadFactorList();
            }, 1000);
        } else {
            statusText.textContent = 'è¯„ä¼°å¤±è´¥: ' + (data.message || data.error);
            showError('è¯„ä¼°å¤±è´¥: ' + (data.message || data.error));
        }
    })
    .catch(error => {
        statusText.textContent = 'è¯„ä¼°å¤±è´¥: ' + error.message;
        showError('è¯„ä¼°å¤±è´¥: ' + error.message);
    });
}

// æ˜¾ç¤ºè¯„ä¼°ç»“æœ
function displayEvaluationResults(results) {
    const resultsDiv = document.getElementById('evaluationResults');
    const contentDiv = document.getElementById('evaluationResultsContent');
    const chartsContainer = document.getElementById('evaluationChartsContainer');
    
    if (!results) {
        contentDiv.innerHTML = '<p class="text-muted">æ²¡æœ‰è¯„ä¼°ç»“æœ</p>';
        resultsDiv.style.display = 'block';
        chartsContainer.style.display = 'none';
        return;
    }
    
    // è°ƒè¯•ï¼šè¾“å‡ºæ”¶åˆ°çš„ç»“æœæ•°æ®ç»“æ„
    console.log('æ”¶åˆ°çš„è¯„ä¼°ç»“æœ:', results);
    console.log('ç»“æœå­—æ®µå:', Object.keys(results));
    
    // æ ¼å¼åŒ–è¯„ä¼°ç»“æœ
    let html = '<div class="row">';
    
    // æ˜¾ç¤ºä¸»è¦æŒ‡æ ‡
    if (results.ic_pearson !== undefined) {
        html += `
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <h6 class="card-title">ä¿¡æ¯ç³»æ•° (IC)</h6>
                        <h4 class="text-primary">${results.ic_pearson.toFixed(4)}</h4>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (results.ic_spearman !== undefined) {
        html += `
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h6 class="card-title">ç­‰çº§IC (Spearman)</h6>
                        <h4 class="text-info">${results.ic_spearman.toFixed(4)}</h4>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (results.win_rate !== undefined) {
        html += `
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h6 class="card-title">èƒœç‡</h6>
                        <h4 class="text-success">${(results.win_rate * 100).toFixed(2)}%</h4>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (results.sharpe_ratio !== undefined) {
        html += `
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h6 class="card-title">å¤æ™®æ¯”ç‡</h6>
                        <h4 class="text-warning">${results.sharpe_ratio.toFixed(4)}</h4>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (results.long_short_return !== undefined) {
        html += `
            <div class="col-md-3">
                <div class="card border-secondary">
                    <div class="card-body text-center">
                        <h6 class="card-title">å¤šç©ºæ”¶ç›Š</h6>
                        <h4 class="text-secondary">${(results.long_short_return * 100).toFixed(2)}%</h4>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    
    // æ·»åŠ è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
    html += '<div class="mt-3"><h6>è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯:</h6><div class="table-responsive"><table class="table table-sm">';
    
    for (const [key, value] of Object.entries(results)) {
        if (typeof value === 'number') {
            html += `<tr><td>${key}</td><td>${value.toFixed(6)}</td></tr>`;
        } else {
            html += `<tr><td>${key}</td><td>${value}</td></tr>`;
        }
    }
    
    html += '</table></div></div>';
    
    contentDiv.innerHTML = html;
    resultsDiv.style.display = 'block';

    // æ¸²æŸ“ä¸»è¦æŒ‡æ ‡æ¡å½¢å›¾ï¼ˆè‹¥å­˜åœ¨ï¼‰
    const metrics = [];
    if (results.ic_pearson !== undefined) metrics.push({ label: 'IC', value: results.ic_pearson });
    if (results.ic_spearman !== undefined) metrics.push({ label: 'ç­‰çº§IC', value: results.ic_spearman });
    if (results.win_rate !== undefined) metrics.push({ label: 'èƒœç‡', value: results.win_rate });
    if (results.sharpe_ratio !== undefined) metrics.push({ label: 'å¤æ™®', value: results.sharpe_ratio });
    if (results.long_short_return !== undefined) metrics.push({ label: 'å¤šç©ºæ”¶ç›Š', value: results.long_short_return });

    const canvas = document.getElementById('evaluationBarChart');
    if (metrics.length > 0 && canvas) {
        chartsContainer.style.display = 'block';
        if (canvas._chartInstance) {
            canvas._chartInstance.destroy();
        }
        const data = {
            labels: metrics.map(m => m.label),
            datasets: [{
                label: 'å…³é”®æŒ‡æ ‡',
                data: metrics.map(m => m.value),
                backgroundColor: 'rgba(54, 162, 235, 0.4)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        };
        const options = {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        };
        canvas._chartInstance = new Chart(canvas.getContext('2d'), { type: 'bar', data, options });
    } else {
        chartsContainer.style.display = 'none';
    }
}

// å¯¼å‡ºå› å­
function exportFactor() {
    if (!selectedFactor) {
        showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå› å­');
        return;
    }
    
    // è¿™é‡Œå¯ä»¥å®ç°å› å­å¯¼å‡ºåŠŸèƒ½
    alert(`å¯¼å‡ºå› å­: ${selectedFactor.name}`);
}



// åˆ·æ–°å› å­åˆ—è¡¨
function refreshFactorList() {
    loadFactorList();
}

// åŠ è½½äº¤æ˜“å¯¹åˆ—è¡¨
async function loadSymbols() {
    try {
        const exchange = document.getElementById('evaluationExchange').value;
        const tradeType = document.getElementById('evaluationTradeType').value;
        
        if (!exchange || !tradeType) {
            console.log('äº¤æ˜“æ‰€æˆ–äº¤æ˜“ç±»å‹æœªé€‰æ‹©');
            return;
        }
        
        console.log('å¼€å§‹åŠ è½½äº¤æ˜“å¯¹...', { exchange, tradeType });
        const url = `/api/data/local-data?exchange=${exchange}&trade_type=${tradeType}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success && data.data && data.data.length > 0) {
            const select = document.getElementById('evaluationSymbol');
            select.innerHTML = '<option value="">é€‰æ‹©äº¤æ˜“å¯¹</option>';
            
            // è·å–å”¯ä¸€çš„äº¤æ˜“å¯¹
            const uniqueSymbols = [...new Set(data.data.map(item => item.symbol))];
            
            uniqueSymbols.forEach(symbol => {
                select.innerHTML += `<option value="${symbol}">${symbol}</option>`;
            });
            
            // å¯ç”¨äº¤æ˜“å¯¹é€‰æ‹©
            select.disabled = false;
        } else {
            const select = document.getElementById('evaluationSymbol');
            select.innerHTML = '<option value="">æ— å¯ç”¨æ•°æ®</option>';
            select.disabled = true;
        }
    } catch (error) {
        const select = document.getElementById('evaluationSymbol');
        select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        select.disabled = true;
    }
}

// åŠ è½½æ—¶é—´æ¡†æ¶åˆ—è¡¨
async function loadTimeframes() {
    try {
        const exchange = document.getElementById('evaluationExchange').value;
        const tradeType = document.getElementById('evaluationTradeType').value;
        const symbol = document.getElementById('evaluationSymbol').value;
        
        if (!exchange || !tradeType || !symbol) {
            return;
        }
        
        const url = `/api/data/local-data?exchange=${exchange}&trade_type=${tradeType}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success && data.data && data.data.length > 0) {
            const select = document.getElementById('evaluationTimeframe');
            select.innerHTML = '<option value="">é€‰æ‹©æ—¶é—´æ¡†æ¶</option>';
            
            // ä»…å–å½“å‰é€‰ä¸­äº¤æ˜“å¯¹çš„æ—¶é—´æ¡†æ¶
            let timeframesForSymbol = [...new Set(data.data.filter(item => item.symbol === symbol).map(item => item.timeframe))];
            // æŒ‰æ—¶é—´ä»å°åˆ°å¤§æ’åº
            timeframesForSymbol.sort((a, b) => timeframeToMinutes(a) - timeframeToMinutes(b));
            
            timeframesForSymbol.forEach(tf => {
                select.innerHTML += `<option value="${tf}">${tf}</option>`;
            });
            
            select.disabled = timeframesForSymbol.length === 0;
        } else {
            const select = document.getElementById('evaluationTimeframe');
            select.innerHTML = '<option value="">æ— å¯ç”¨æ•°æ®</option>';
            select.disabled = true;
        }
    } catch (error) {
        const select = document.getElementById('evaluationTimeframe');
        select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        select.disabled = true;
    }
}

// äº¤æ˜“å¯¹å˜åŒ–ï¼šåˆ·æ–°æ—¶é—´æ¡†æ¶ï¼Œå¹¶éšè—æ—¥æœŸæ»‘æ¡
function onSymbolChange() {
    loadTimeframes();
    hideDateSlider();
}

// æ—¶é—´æ¡†æ¶å˜åŒ–ï¼šåŠ è½½è¯¥å¸å¯¹åœ¨è¯¥æ—¶é—´æ¡†æ¶çš„å¯ç”¨æ—¶é—´æ®µï¼Œæ˜¾ç¤ºæ»‘æ¡
async function onTimeframeChange() {
    try {
        const exchange = document.getElementById('evaluationExchange').value;
        const tradeType = document.getElementById('evaluationTradeType').value;
        const symbol = document.getElementById('evaluationSymbol').value;
        const timeframe = document.getElementById('evaluationTimeframe').value;
        if (!exchange || !tradeType || !symbol || !timeframe) {
            hideDateSlider();
            return;
        }
        const url = `/api/data/local-data?exchange=${exchange}&trade_type=${tradeType}`;
        const response = await fetch(url);
        const data = await response.json();
        if (!(data.success && data.data)) { hideDateSlider(); return; }
        const rows = data.data.filter(item => item.symbol === symbol && item.timeframe === timeframe);
        if (rows.length === 0) { hideDateSlider(); return; }
        const dateRange = rows[0].date_range;
        setupDateSlider(dateRange.start, dateRange.end);
    } catch (e) {
        hideDateSlider();
    }
}

function hideDateSlider() {
    const c = document.getElementById('dateRangeSliderContainer');
    if (c) c.style.display = 'none';
}

function setupDateSlider(startStr, endStr) {
    const container = document.getElementById('dateRangeSliderContainer');
    const info = document.getElementById('dateRangeInfo');
    const sLabel = document.getElementById('dateSliderStartLabel');
    const eLabel = document.getElementById('dateSliderEndLabel');
    // ç»Ÿä¸€æŒ‰ ISO å­—ç¬¦ä¸²è§£æ
    const startDate = new Date(startStr);
    const endDate = new Date(endStr);
    if (isNaN(startDate) || isNaN(endDate) || startDate >= endDate) { hideDateSlider(); return; }
    const totalMs = endDate - startDate;
    info.textContent = `å¯ç”¨åŒºé—´ï¼š${startStr} ~ ${endStr}`;
    container.style.display = 'block';

    const slider = document.getElementById('dateRangeSlider');
    // è‹¥å·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
    if (slider.noUiSlider) {
        slider.noUiSlider.destroy();
    }
    noUiSlider.create(slider, {
        start: [0, 100],
        connect: true,
        step: 1,
        range: { min: 0, max: 100 },
        behaviour: 'tap-drag',
    });

    const updateFromSlider = (values) => {
        const sv = parseInt(values[0], 10);
        const ev = parseInt(values[1], 10);
        const startSel = new Date(startDate.getTime() + (sv / 100) * totalMs);
        const endSel = new Date(startDate.getTime() + (ev / 100) * totalMs);
        const toDateInput = (d) => d.toISOString().slice(0,10);
        document.getElementById('evaluationStartDate').value = toDateInput(startSel);
        document.getElementById('evaluationEndDate').value = toDateInput(endSel);
        sLabel.textContent = toDateInput(startSel);
        eLabel.textContent = toDateInput(endSel);
    };

    slider.noUiSlider.on('update', updateFromSlider);
    updateFromSlider([0, 100]);
}

// å·¥å…·å‡½æ•°
function getTypeBadgeColor(type) {
    switch (type) {
        case 'Alpha101': return 'primary';
        case 'ML': return 'success';
        case 'Traditional': return 'info';
        default: return 'secondary';
    }
}

function getICColor(ic) {
    if (ic > 0.05) return 'success';
    if (ic > 0.02) return 'warning';
    return 'danger';
}

// å°†æ—¶é—´æ¡†æ¶å­—ç¬¦ä¸²è½¬æ¢ä¸ºåˆ†é’Ÿæ•°ï¼Œä¾¿äºæ’åº
function timeframeToMinutes(tf) {
    if (!tf) return Number.MAX_SAFE_INTEGER;
    const match = tf.match(/^(\d+)([mhd])$/);
    if (!match) return Number.MAX_SAFE_INTEGER;
    const value = parseInt(match[1], 10);
    const unit = match[2];
    switch (unit) {
        case 'm': return value;
        case 'h': return value * 60;
        case 'd': return value * 60 * 24;
        default: return Number.MAX_SAFE_INTEGER;
    }
}

function showError(message) {
    // è¿™é‡Œå¯ä»¥å®ç°é”™è¯¯æç¤º
    alert('é”™è¯¯: ' + message);
}

function showSuccess(message) {
    // è¿™é‡Œå¯ä»¥å®ç°æˆåŠŸæç¤º
    alert('æˆåŠŸ: ' + message);
}

// å›åˆ°é¡¶éƒ¨
function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
{% endblock %} 