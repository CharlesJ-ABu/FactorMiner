{% extends "base.html" %}

{% block title %}æ•°æ®ä¸‹è½½ - {{ config.title }}{% endblock %}

{% block content %}
<div class="row mb-2">
    <div class="col-12">
        <h2>ğŸ“¥ æ•°æ®ä¸‹è½½</h2>
        <p class="text-muted">ä»äº¤æ˜“æ‰€ä¸‹è½½å†å²è¡Œæƒ…æ•°æ®</p>
    </div>
</div>

<div class="row">
    <!-- å·¦ä¾§ï¼šäº¤æ˜“æ‰€å’Œäº§å“é€‰æ‹© -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0">âš™ï¸ æ•°æ®æºé…ç½®</h6>
            </div>
            <div class="card-body" style="overflow-y: auto;">
                <form id="dataConfigForm">
                    <div class="mb-2">
                        <label for="exchange" class="form-label small mb-1">äº¤æ˜“æ‰€</label>
                        <select class="form-select form-select-sm" id="exchange" name="exchange">
                            <option value="binance">Binance (åŠ å¯†è´§å¸)</option>
                            <option value="okx">OKX (åŠ å¯†è´§å¸)</option>
                            <option value="bybit">Bybit (åŠ å¯†è´§å¸)</option>
                        </select>
                    </div>
                    
                    <div class="mb-2">
                        <label for="tradeType" class="form-label small mb-1">äº¤æ˜“ç±»å‹</label>
                        <select class="form-select form-select-sm" id="tradeType" name="tradeType">
                            <option value="">è¯·å…ˆé€‰æ‹©äº¤æ˜“æ‰€</option>
                            <option value="spot">ç°è´§ (Spot)</option>
                            <option value="perpetual">æ°¸ç»­åˆçº¦ (Perpetual)</option>
                            <option value="delivery">äº¤å‰²åˆçº¦ (Delivery)</option>
                        </select>
                    </div>
                    
                    <div class="mb-2">
                        <label for="symbol" class="form-label small mb-1">äº¤æ˜“å¯¹</label>
                        <select class="form-select form-select-sm" id="symbol" name="symbol">
                            <option value="">è¯·å…ˆé€‰æ‹©äº¤æ˜“ç±»å‹</option>
                        </select>
                    </div>
                    
                    <div class="mb-2">
                        <label for="timeframe" class="form-label small mb-1">æ—¶é—´æ¡†æ¶</label>
                        <select class="form-select form-select-sm" id="timeframe" name="timeframe">
                            <option value="">è¯·å…ˆé€‰æ‹©äº¤æ˜“æ‰€å’Œäº¤æ˜“ç±»å‹</option>
                        </select>
                    </div>
                    
                    <div class="mb-2">
                        <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="getDownloadSuggestions()">
                            ğŸ” æŸ¥è¯¢ç°æœ‰æ•°æ®
                        </button>
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-6">
                            <label for="startDate" class="form-label small mb-1">å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" class="form-control form-control-sm" id="startDate" name="startDate">
                        </div>
                        <div class="col-6">
                            <label for="endDate" class="form-label small mb-1">ç»“æŸæ—¥æœŸ</label>
                            <input type="date" class="form-control form-control-sm" id="endDate" name="endDate">
                        </div>
                    </div>
                    

                    
                    <div class="mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="mergeWithExisting" name="mergeWithExisting" checked>
                            <label class="form-check-label small" for="mergeWithExisting">
                                ğŸ”„ ä¸ç°æœ‰æ•°æ®åˆå¹¶
                            </label>
                        </div>
                        <small class="form-text text-muted small">
                            å‹¾é€‰åå°†è‡ªåŠ¨ä¸ç°æœ‰æ•°æ®åˆå¹¶ï¼Œé¿å…é‡å¤æ•°æ®
                        </small>
                    </div>
                    
                    <div class="mb-2">
                        <div class="alert alert-info alert-sm mb-0">
                            <i class="fas fa-info-circle"></i>
                            <strong>æ™ºèƒ½åˆå¹¶ï¼š</strong>ç³»ç»Ÿå°†è‡ªåŠ¨ä¸ç°æœ‰æ•°æ®åˆå¹¶ï¼Œå¤„ç†é‡å æ—¶é—´æ®µï¼Œä¿ç•™æœ€æ–°æ•°æ®ï¼Œç¡®ä¿æ•°æ®è¿ç»­æ€§
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        ğŸš€ å¼€å§‹ä¸‹è½½
                    </button>
                </form>
                
                <hr class="my-3">
                
                <!-- æ‰¹é‡ä¸‹è½½è¡¨å• -->
                <div class="mb-2">
                    <h6 class="mb-2">ğŸ“¦ æ‰¹é‡ä¸‹è½½</h6>
                    <form id="batchDownloadForm">
                        <div class="mb-3">
                            <label for="batchSymbols" class="form-label small mb-1">é€‰æ‹©äº¤æ˜“å¯¹ (å¤šé€‰)</label>
                            <select class="form-select" id="batchSymbols" name="batchSymbols" multiple size="8" style="min-height: 200px;">
                                <option value="">è¯·å…ˆé€‰æ‹©äº¤æ˜“ç±»å‹</option>
                            </select>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <small class="form-text text-muted">æŒ‰ä½ Ctrl/Cmd é”®å¯å¤šé€‰</small>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectAllSymbols()">å…¨é€‰</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllSymbols()">æ¸…ç©º</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="batchTimeframes" class="form-label small mb-1">é€‰æ‹©æ—¶é—´æ¡†æ¶ (å¤šé€‰)</label>
                            <select class="form-select" id="batchTimeframes" name="batchTimeframes" multiple size="6" style="min-height: 150px;">
                                <option value="">è¯·å…ˆé€‰æ‹©äº¤æ˜“æ‰€å’Œäº¤æ˜“ç±»å‹</option>
                            </select>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <small class="form-text text-muted">æŒ‰ä½ Ctrl/Cmd é”®å¯å¤šé€‰</small>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectAllTimeframes()">å…¨é€‰</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllTimeframes()">æ¸…ç©º</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="alert alert-info small mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>ğŸ“Š é€‰æ‹©ç»Ÿè®¡:</span>
                                    <span id="batchSelectionStats">æœªé€‰æ‹©</span>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-warning btn-sm w-100" onclick="startBatchDownload()">
                                ğŸš€ å¼€å§‹æ‰¹é‡ä¸‹è½½
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å³ä¾§ï¼šæ•°æ®è¦†ç›–æƒ…å†µå’Œä¸‹è½½å»ºè®® -->
    <div class="col-md-8">
        <div class="row h-100">
            <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šæ•°æ®è¦†ç›–æƒ…å†µå’Œä¸‹è½½å»ºè®® -->
            <div class="col-12 mb-2">
                <div class="row">
                    <!-- æ•°æ®è¦†ç›–æƒ…å†µ -->
                    <div class="col-6 h-100">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0">ğŸ“Š æ•°æ®è¦†ç›–æƒ…å†µ</h6>
                            </div>
                            <div class="card-body" style="overflow-y: auto;">
                                <div id="dataCoverage">
                                    <p class="text-muted">é€‰æ‹©äº¤æ˜“å¯¹å’Œæ—¶é—´æ¡†æ¶åï¼Œç‚¹å‡»"æŸ¥è¯¢ç°æœ‰æ•°æ®"æŸ¥çœ‹è¦†ç›–æƒ…å†µ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä¸‹è½½å»ºè®® -->
                    <div class="col-6 h-100">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0">ğŸ’¡ æ™ºèƒ½ä¸‹è½½å»ºè®®</h6>
                            </div>
                            <div class="card-body" style="overflow-y: auto;">
                                <div id="downloadSuggestions">
                                    <p class="text-muted">åŸºäºç°æœ‰æ•°æ®ç”Ÿæˆæ™ºèƒ½ä¸‹è½½å»ºè®®</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸‹åŠéƒ¨åˆ†ï¼šä¸‹è½½è¿›åº¦å’Œå†å² -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ğŸ“ˆ ä¸‹è½½è¿›åº¦</h6>
                    </div>
                    <div class="card-body" style="overflow-y: auto;">
                        <div id="downloadProgress" style="display: none;">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <p id="progressText" class="text-muted mb-3">å‡†å¤‡ä¸­...</p>
                        </div>
                        
                        <div id="downloadHistory">
                            <h6 class="mb-3">ğŸ“‹ ä¸‹è½½å†å²</h6>
                            <div id="historyList" class="list-group list-group-flush" style="max-height: 150px; overflow-y: auto;">
                                <!-- ä¸‹è½½å†å²å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ åº•éƒ¨è¾¹è·ï¼Œç¡®ä¿footerä¸è¢«æŒ¡ä½ -->
<div style="margin-bottom: 50px;"></div>

{% endblock %}

{% block extra_js %}
<script>
// æ•°æ®ç®¡ç†é¡µé¢çš„JavaScriptä»£ç 
document.addEventListener('DOMContentLoaded', function() {
    console.log('æ•°æ®ç®¡ç†é¡µé¢åˆå§‹åŒ–');
    
    // åˆå§‹åŒ–è¡¨å•
    initDataConfigForm();
});

function initDataConfigForm() {
    const form = document.getElementById('dataConfigForm');
    const exchangeSelect = document.getElementById('exchange');
    const tradeTypeSelect = document.getElementById('tradeType');
    const symbolSelect = document.getElementById('symbol');
    const timeframeSelect = document.getElementById('timeframe');
    
    // ä¸ºæ‰¹é‡ä¸‹è½½é€‰æ‹©æ¡†æ·»åŠ changeäº‹ä»¶ç›‘å¬å™¨
    const batchSymbolsSelect = document.getElementById('batchSymbols');
    const batchTimeframesSelect = document.getElementById('batchTimeframes');
    
    if (batchSymbolsSelect) {
        batchSymbolsSelect.addEventListener('change', updateBatchSelectionStats);
    }
    if (batchTimeframesSelect) {
        batchTimeframesSelect.addEventListener('change', updateBatchSelectionStats);
    }
    
    // è®¾ç½®é»˜è®¤æ—¥æœŸ
    const today = new Date();
    const oneMonthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
    
    document.getElementById('startDate').value = oneMonthAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    
    // äº¤æ˜“æ‰€å˜åŒ–æ—¶æ›´æ–°äº¤æ˜“ç±»å‹
    exchangeSelect.addEventListener('change', function() {
        updateTradeTypes(this.value);
        clearDataCoverage();
    });
    
    // äº¤æ˜“ç±»å‹å˜åŒ–æ—¶æ›´æ–°äº¤æ˜“å¯¹å’Œæ—¶é—´æ¡†æ¶
    tradeTypeSelect.addEventListener('change', function() {
        updateSymbols();
        updateTimeframes();
        clearDataCoverage();
    });
    
    // äº¤æ˜“å¯¹æˆ–æ—¶é—´æ¡†æ¶å˜åŒ–æ—¶æ¸…é™¤è¦†ç›–æƒ…å†µ
    symbolSelect.addEventListener('change', function() {
        clearDataCoverage();
    });
    
    timeframeSelect.addEventListener('change', function() {
        clearDataCoverage();
    });
    
    // åˆå¹¶é€‰é¡¹äº¤äº’ - ç°åœ¨æ€»æ˜¯å¯ç”¨æ™ºèƒ½åˆå¹¶
    const mergeCheckbox = document.getElementById('mergeWithExisting');
    
    // æ€»æ˜¯å¯ç”¨æ™ºèƒ½åˆå¹¶
    mergeCheckbox.checked = true;
    mergeCheckbox.disabled = true;
    
    // è¡¨å•æäº¤
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        startDownload();
    });
    
    // åˆå§‹åŒ–æ—¶è‡ªåŠ¨è§¦å‘ç¬¬ä¸€ä¸ªäº¤æ˜“æ‰€çš„é€‰æ‹©
    if (exchangeSelect.value) {
        updateTradeTypes(exchangeSelect.value);
    }
}

function updateTradeTypes(exchange) {
    const tradeTypeSelect = document.getElementById('tradeType');
    const symbolSelect = document.getElementById('symbol');
    
    // é‡ç½®é€‰æ‹©æ¡†
    tradeTypeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©äº¤æ˜“ç±»å‹</option>';
    symbolSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©äº¤æ˜“ç±»å‹</option>';
    
    // æ¢å¤ä¸ºï¼šç°è´§ / æœŸè´§
    const spotOption = document.createElement('option');
    spotOption.value = 'spot';
    spotOption.textContent = 'ç°è´§ (Spot)';
    tradeTypeSelect.appendChild(spotOption);
    
    const futuresOption = document.createElement('option');
    futuresOption.value = 'futures';
    futuresOption.textContent = 'æœŸè´§ (Futures)';
    tradeTypeSelect.appendChild(futuresOption);
}

async function updateSymbols() {
    const exchange = document.getElementById('exchange').value;
    const tradeType = document.getElementById('tradeType').value;
    const symbolSelect = document.getElementById('symbol');
    
    if (!tradeType) {
        symbolSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©äº¤æ˜“ç±»å‹</option>';
        return;
    }
    
    symbolSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
    
    try {
        const response = await fetch(`/api/data/symbols/${exchange}`);
        const result = await response.json();
        
        // futures ç›´æ¥æ˜¾ç¤ºæ°¸ç»­åˆçº¦
        if (result.success && result.data[tradeType]) {
            symbolSelect.innerHTML = '<option value="">è¯·é€‰æ‹©äº¤æ˜“å¯¹</option>';
            
            const markets = result.data[tradeType] || [];
            if (markets && markets.length > 0) {
                // è¿‡æ»¤ï¼šåªæ˜¾ç¤º USDT è®¡ä»·ä¸”çŠ¶æ€ä¸º active çš„äº¤æ˜“å¯¹
                const filteredMarkets = markets.filter(item => 
                    item.quote === 'USDT' && item.active === true
                );
                
                if (filteredMarkets.length > 0) {
                    filteredMarkets.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.symbol;
                        
                        // æœŸè´§åªæ˜¾ç¤ºæ°¸ç»­åˆçº¦ï¼Œä¸éœ€è¦æ˜¾ç¤ºåˆ°æœŸæ—¥
                        option.textContent = `${item.symbol} (${item.name})`;
                        
                        symbolSelect.appendChild(option);
                    });
                    
                    console.log(`æ˜¾ç¤º ${filteredMarkets.length} ä¸ªç¬¦åˆæ¡ä»¶çš„äº¤æ˜“å¯¹`);
                } else {
                    symbolSelect.innerHTML = '<option value="">æš‚æ— ç¬¦åˆæ¡ä»¶çš„äº¤æ˜“å¯¹</option>';
                }
            } else {
                symbolSelect.innerHTML = '<option value="">æš‚æ— å¯ç”¨äº¤æ˜“å¯¹</option>';
            }
        } else {
            symbolSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        }
    } catch (error) {
        console.error('åŠ è½½äº¤æ˜“å¯¹å¤±è´¥:', error);
        symbolSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
    }
    
    // åŒæ—¶æ›´æ–°æ‰¹é‡ä¸‹è½½çš„äº¤æ˜“å¯¹é€‰æ‹©æ¡†
    updateBatchSymbols();
}

async function updateBatchSymbols() {
    const exchange = document.getElementById('exchange').value;
    const tradeType = document.getElementById('tradeType').value;
    const batchSymbolSelect = document.getElementById('batchSymbols');
    
    if (!tradeType) {
        batchSymbolSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©äº¤æ˜“ç±»å‹</option>';
        return;
    }
    
    batchSymbolSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
    
    try {
        const response = await fetch(`/api/data/symbols/${exchange}`);
        const result = await response.json();
        
        if (result.success && result.data[tradeType]) {
            batchSymbolSelect.innerHTML = '<option value="">è¯·é€‰æ‹©äº¤æ˜“å¯¹ (å¯å¤šé€‰)</option>';
            
            const markets = result.data[tradeType] || [];
            if (markets && markets.length > 0) {
                // è¿‡æ»¤ï¼šåªæ˜¾ç¤º USDT è®¡ä»·ä¸”çŠ¶æ€ä¸º active çš„äº¤æ˜“å¯¹
                const filteredMarkets = markets.filter(item => 
                    item.quote === 'USDT' && item.active === true
                );
                
                if (filteredMarkets.length > 0) {
                    filteredMarkets.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.symbol;
                        option.textContent = `${item.symbol} (${item.name})`;
                        batchSymbolSelect.appendChild(option);
                    });
                    
                    console.log(`æ‰¹é‡ä¸‹è½½æ˜¾ç¤º ${filteredMarkets.length} ä¸ªç¬¦åˆæ¡ä»¶çš„äº¤æ˜“å¯¹`);
                } else {
                    batchSymbolSelect.innerHTML = '<option value="">æš‚æ— ç¬¦åˆæ¡ä»¶çš„äº¤æ˜“å¯¹</option>';
                }
            } else {
                batchSymbolSelect.innerHTML = '<option value="">æš‚æ— å¯ç”¨äº¤æ˜“å¯¹</option>';
            }
        } else {
            batchSymbolSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        }
    } catch (error) {
        console.error('åŠ è½½æ‰¹é‡ä¸‹è½½äº¤æ˜“å¯¹å¤±è´¥:', error);
        batchSymbolSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
    }
}

async function updateTimeframes() {
    const exchange = document.getElementById('exchange').value;
    const tradeType = document.getElementById('tradeType').value;
    const timeframeSelect = document.getElementById('timeframe');
    
    if (!exchange || !tradeType) {
        timeframeSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©äº¤æ˜“æ‰€å’Œäº¤æ˜“ç±»å‹</option>';
        return;
    }
    
    timeframeSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
    
    try {
        const response = await fetch(`/api/data/timeframes?exchange=${exchange}&trade_type=${tradeType}`);
        const result = await response.json();
        
        if (result.success) {
            timeframeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ—¶é—´æ¡†æ¶</option>';
            
            result.data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.value;
                option.textContent = `${item.name} (${item.value})`;
                option.title = item.description;
                timeframeSelect.appendChild(option);
            });
            
            console.log(`åŠ è½½äº† ${result.data.length} ä¸ªæ—¶é—´æ¡†æ¶é€‰é¡¹`);
        } else {
            timeframeSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            console.error('åŠ è½½æ—¶é—´æ¡†æ¶å¤±è´¥:', result.error);
        }
    } catch (error) {
        console.error('åŠ è½½æ—¶é—´æ¡†æ¶å¤±è´¥:', error);
        timeframeSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
    }
    
    // åŒæ—¶æ›´æ–°æ‰¹é‡ä¸‹è½½çš„æ—¶é—´æ¡†æ¶é€‰æ‹©æ¡†
    updateBatchTimeframes();
}

async function updateBatchTimeframes() {
    const exchange = document.getElementById('exchange').value;
    const tradeType = document.getElementById('tradeType').value;
    const batchTimeframeSelect = document.getElementById('batchTimeframes');
    
    if (!exchange || !tradeType) {
        batchTimeframeSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©äº¤æ˜“æ‰€å’Œäº¤æ˜“ç±»å‹</option>';
        return;
    }
    
    batchTimeframeSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
    
    try {
        const response = await fetch(`/api/data/timeframes?exchange=${exchange}&trade_type=${tradeType}`);
        const result = await response.json();
        
        if (result.success) {
            batchTimeframeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ—¶é—´æ¡†æ¶ (å¯å¤šé€‰)</option>';
            
            result.data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.value;
                option.textContent = `${item.name} (${item.value})`;
                option.title = item.description;
                batchTimeframeSelect.appendChild(option);
            });
        } else {
            batchTimeframeSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        }
    } catch (error) {
        console.error('åŠ è½½æ‰¹é‡ä¸‹è½½æ—¶é—´æ¡†æ¶å¤±è´¥:', error);
        batchTimeframeSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
    }
}

async function startDownload() {
    const form = document.getElementById('dataConfigForm');
    const formData = new FormData(form);
    
    const downloadData = {
        exchange: formData.get('exchange'),
        trade_type: formData.get('tradeType'),
        symbol: formData.get('symbol'),
        timeframe: formData.get('timeframe'),
        start_date: formData.get('startDate'),
        end_date: formData.get('endDate'),
        merge_with_existing: document.getElementById('mergeWithExisting').checked,
        merge_strategy: 'smart'  // å›ºå®šä½¿ç”¨æ™ºèƒ½åˆå¹¶ç­–ç•¥
    };
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!downloadData.exchange || !downloadData.trade_type || !downloadData.symbol || !downloadData.timeframe) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼šäº¤æ˜“æ‰€ã€äº¤æ˜“ç±»å‹ã€äº¤æ˜“å¯¹ã€æ—¶é—´æ¡†æ¶');
        return;
    }
    
    // éªŒè¯æ—¥æœŸ
    if (!downloadData.start_date || !downloadData.end_date) {
        alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
        return;
    }
    
    if (new Date(downloadData.start_date) >= new Date(downloadData.end_date)) {
        alert('å¼€å§‹æ—¥æœŸå¿…é¡»æ—©äºç»“æŸæ—¥æœŸ');
        return;
    }
    
    if (!downloadData.start_date || !downloadData.end_date) {
        alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
        return;
    }
    
    console.log('å¼€å§‹ä¸‹è½½:', downloadData);
    console.log('è¡¨å•æ•°æ®è¯¦æƒ…:');
    console.log('  exchange:', formData.get('exchange'));
    console.log('  tradeType:', formData.get('tradeType'));
    console.log('  symbol:', formData.get('symbol'));
    console.log('  timeframe:', formData.get('timeframe'));
    console.log('  startDate:', formData.get('startDate'));
    console.log('  endDate:', formData.get('endDate'));
    
    // æ˜¾ç¤ºä¸‹è½½è¿›åº¦
    document.getElementById('downloadProgress').style.display = 'block';
    document.getElementById('progressText').textContent = 'æ­£åœ¨å¯åŠ¨ä¸‹è½½...';
    
    try {
        const response = await fetch('/api/data/download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(downloadData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('ä¸‹è½½å¯åŠ¨æˆåŠŸ:', result.data);
            
            // æ˜¾ç¤ºåˆå¹¶ä¿¡æ¯
            if (result.data.merge_info) {
                const mergeInfo = result.data.merge_info;
                console.log('åˆå¹¶ä¿¡æ¯:', mergeInfo);
                document.getElementById('progressText').textContent = 
                    `æ£€æµ‹åˆ°ç°æœ‰æ•°æ®ï¼Œå°†ä½¿ç”¨${mergeInfo.merge_strategy}æ¨¡å¼åˆå¹¶`;
            }
            
            // å¼€å§‹ç›‘æ§ä¸‹è½½è¿›åº¦
            monitorDownloadProgress(result.data.id, downloadData);
        } else {
            console.error('ä¸‹è½½å¯åŠ¨å¤±è´¥:', result.error);
            alert('ä¸‹è½½å¤±è´¥: ' + result.error);
            document.getElementById('downloadProgress').style.display = 'none';
        }
    } catch (error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
        alert('ä¸‹è½½å¤±è´¥: ' + error.message);
        document.getElementById('downloadProgress').style.display = 'none';
    }
}

async function monitorDownloadProgress(downloadId, downloadData) {
    const progressBar = document.querySelector('.progress-bar');
    const progressText = document.getElementById('progressText');
    
    const interval = setInterval(async () => {
        try {
            const response = await fetch(`/api/data/download-status/${downloadId}`);
            const result = await response.json();
            
            if (result.success) {
                const status = result.data;
                progressBar.style.width = status.progress + '%';
                progressText.textContent = status.message;
                
                if (status.status === 'completed') {
                    clearInterval(interval);
                    
                    // æ·»åŠ åˆ°ä¸‹è½½å†å²
                    addToDownloadHistory(downloadData);
                    
                    setTimeout(() => {
                        document.getElementById('downloadProgress').style.display = 'none';
                    }, 1000);
                }
            } else {
                clearInterval(interval);
                alert('è·å–ä¸‹è½½çŠ¶æ€å¤±è´¥: ' + result.error);
                document.getElementById('downloadProgress').style.display = 'none';
            }
        } catch (error) {
            clearInterval(interval);
            console.error('ç›‘æ§ä¸‹è½½è¿›åº¦å¤±è´¥:', error);
            document.getElementById('downloadProgress').style.display = 'none';
        }
    }, 1000);
}

function addToDownloadHistory(downloadData) {
    const historyList = document.getElementById('historyList');
    const historyItem = document.createElement('div');
    historyItem.className = 'list-group-item d-flex justify-content-between align-items-center';
    
    const tradeTypeText = downloadData.trade_type === 'futures' ? 'æœŸè´§' : 'ç°è´§';
    
    historyItem.innerHTML = `
        <div>
            <strong>${downloadData.exchange.toUpperCase()}</strong> - ${downloadData.symbol} (${tradeTypeText}, ${downloadData.timeframe})
            <br><small class="text-muted">${downloadData.start_date} åˆ° ${downloadData.end_date}</small>
        </div>
        <span class="badge bg-success">å®Œæˆ</span>
    `;
    
    historyList.insertBefore(historyItem, historyList.firstChild);
}

function clearDataCoverage() {
    document.getElementById('dataCoverage').innerHTML = '<p class="text-muted">é€‰æ‹©äº¤æ˜“å¯¹å’Œæ—¶é—´æ¡†æ¶åï¼Œç‚¹å‡»"æŸ¥è¯¢ç°æœ‰æ•°æ®"æŸ¥çœ‹è¦†ç›–æƒ…å†µ</p>';
    document.getElementById('downloadSuggestions').innerHTML = '<p class="text-muted">åŸºäºç°æœ‰æ•°æ®ç”Ÿæˆæ™ºèƒ½ä¸‹è½½å»ºè®®</p>';
}

// å°†å†…éƒ¨ trade_type è½¬æ¢ä¸ºä¸­æ–‡å±•ç¤ºæ–‡æœ¬
function tradeTypeToText(t) {
    if (t === 'spot') return 'ç°è´§';
    if (t === 'futures') return 'æœŸè´§';
    if (t === 'perpetual') return 'æ°¸ç»­åˆçº¦';
    if (t === 'delivery') return 'äº¤å‰²åˆçº¦';
    return t || 'æœªçŸ¥';
}

async function getDownloadSuggestions() {
    const exchange = document.getElementById('exchange').value;
    const tradeType = document.getElementById('tradeType').value;
    const symbol = document.getElementById('symbol').value;
    const timeframe = document.getElementById('timeframe').value;
    
    if (!symbol) {
        alert('è¯·å…ˆé€‰æ‹©äº¤æ˜“å¯¹');
        return;
    }
    
    if (!tradeType) {
        alert('è¯·å…ˆé€‰æ‹©äº¤æ˜“ç±»å‹');
        return;
    }
    
    try {
        const response = await fetch('/api/data/download-suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                exchange: exchange,
                trade_type: tradeType,
                symbol: symbol,
                timeframe: timeframe
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // ä¿å­˜å»ºè®®æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾›applySuggestionä½¿ç”¨
            window.currentSuggestionsData = result.data;
            displayDataCoverage(result.data);
            displayDownloadSuggestions(result.data);
        } else {
            alert('è·å–æ•°æ®å»ºè®®å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('è·å–æ•°æ®å»ºè®®å¤±è´¥:', error);
        alert('è·å–æ•°æ®å»ºè®®å¤±è´¥: ' + error.message);
    }
}

function displayDataCoverage(data) {
    const coverageDiv = document.getElementById('dataCoverage');
    
    const tradeTypeText = tradeTypeToText(data.trade_type);
    
    if (data.existing_data.length === 0) {
        coverageDiv.innerHTML = `
            <div class="alert alert-info">
                <h6>ğŸ“Š ${data.symbol} (${tradeTypeText}, ${data.timeframe}) æ•°æ®è¦†ç›–æƒ…å†µ</h6>
                <p>æš‚æ— ç°æœ‰æ•°æ®</p>
            </div>
        `;
        return;
    }
    
    let coverageHtml = `
        <div class="alert alert-success">
            <h6>ğŸ“Š ${data.symbol} (${tradeTypeText}, ${data.timeframe}) æ•°æ®è¦†ç›–æƒ…å†µ</h6>
            <div class="row">
    `;
    
    data.existing_data.forEach(item => {
        coverageHtml += `
            <div class="col-md-6 mb-2">
                <div class="card">
                    <div class="card-body p-2">
                        <h6 class="card-title">${item.data_type}</h6>
                        <p class="card-text small">
                            <strong>æ—¶é—´èŒƒå›´:</strong> ${item.start_date} åˆ° ${item.end_date}<br>
                            <strong>æ•°æ®ç‚¹æ•°:</strong> ${item.data_points.toLocaleString()}<br>
                            <strong>æ–‡ä»¶å¤§å°:</strong> ${item.file_size}
                        </p>
                    </div>
                </div>
            </div>
        `;
    });
    
    coverageHtml += `
            </div>
        </div>
    `;
    
    coverageDiv.innerHTML = coverageHtml;
}

function displayDownloadSuggestions(data) {
    const suggestionsDiv = document.getElementById('downloadSuggestions');
    let suggestionsHtml = '';
    
    if (data.recommended_downloads.length === 0) {
        suggestionsHtml = `
            <div class="alert alert-warning">
                <h6>ğŸ’¡ ä¸‹è½½å»ºè®®</h6>
                <p>æš‚æ— ä¸‹è½½å»ºè®®</p>
            </div>
        `;
        suggestionsDiv.innerHTML = suggestionsHtml;
        return;
    }
    
    suggestionsHtml = `
        <div class="alert alert-info">
            <h6>ğŸ’¡ æ™ºèƒ½ä¸‹è½½å»ºè®®</h6>
            <div class="row">
    `;
    
    data.recommended_downloads.forEach((suggestion, index) => {
        const dataTypeText = tradeTypeToText(suggestion.data_type);
        suggestionsHtml += `
            <div class="col-12 mb-2">
                <div class="card">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">${dataTypeText} (${suggestion.data_type})</h6>
                                <p class="card-text small">
                                    <strong>å»ºè®®æ—¶é—´èŒƒå›´:</strong> ${suggestion.start_date} åˆ° ${suggestion.end_date}<br>
                                    <strong>å»ºè®®åŸå› :</strong> ${suggestion.reason}
                                </p>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="applySuggestion(${index})">
                                åº”ç”¨å»ºè®®
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    // æ·»åŠ åˆå¹¶å»ºè®®
    if (data.existing_data && data.existing_data.length > 0) {
        suggestionsHtml += `
            <div class="col-12 mt-3">
                <div class="alert alert-success">
                    <h6>ğŸ”„ æ•°æ®åˆå¹¶å»ºè®®</h6>
                    <p class="small">
                        <strong>æ£€æµ‹åˆ°ç°æœ‰æ•°æ®:</strong> ${data.existing_data.length} ä¸ªæ–‡ä»¶<br>
                        <strong>å»ºè®®:</strong> ç³»ç»Ÿå°†è‡ªåŠ¨ä¸ç°æœ‰æ•°æ®åˆå¹¶<br>
                        <strong>å¥½å¤„:</strong> é¿å…é‡å¤æ•°æ®ï¼Œä¿æŒæ•°æ®è¿ç»­æ€§ï¼Œè‡ªåŠ¨å¤„ç†æ—¶é—´é‡å 
                    </p>
                </div>
            </div>
        `;
    }
    
    suggestionsHtml += `
            </div>
        </div>
    `;
    
    suggestionsDiv.innerHTML = suggestionsHtml;
}

function applySuggestion(index) {
    // è·å–å»ºè®®æ•°æ®
    const suggestionsData = window.currentSuggestionsData;
    if (!suggestionsData || !suggestionsData.recommended_downloads || !suggestionsData.recommended_downloads[index]) {
        alert('å»ºè®®æ•°æ®ä¸å¯ç”¨');
        return;
    }
    
    const suggestion = suggestionsData.recommended_downloads[index];
    
    // è‡ªåŠ¨å¡«å……è¡¨å•
    document.getElementById('exchange').value = 'binance'; // é»˜è®¤binance
    document.getElementById('tradeType').value = suggestion.data_type;
    
    // è·å–å½“å‰é€‰æ‹©çš„symbolå’Œtimeframeï¼ˆä»å…¨å±€å˜é‡æˆ–è¡¨å•ä¸­è·å–ï¼‰
    const currentSymbol = document.getElementById('symbol').value || 'BTC/USDT';
    const currentTimeframe = document.getElementById('timeframe').value || '1h';
    
    // æ›´æ–°äº¤æ˜“å¯¹åˆ—è¡¨å’Œæ—¶é—´æ¡†æ¶åˆ—è¡¨
    Promise.all([
        updateSymbols(),
        updateTimeframes()
    ]).then(() => {
        // ç­‰å¾…åˆ—è¡¨æ›´æ–°å®Œæˆåè®¾ç½®å€¼
        setTimeout(() => {
            // è®¾ç½®symbolï¼ˆä½¿ç”¨å½“å‰é€‰æ‹©çš„æˆ–é»˜è®¤å€¼ï¼‰
            document.getElementById('symbol').value = currentSymbol;
            
            // è®¾ç½®æ—¶é—´æ¡†æ¶ï¼ˆä½¿ç”¨å½“å‰é€‰æ‹©çš„æˆ–é»˜è®¤å€¼ï¼‰
            document.getElementById('timeframe').value = currentTimeframe;
            
            // è®¾ç½®æ—¥æœŸèŒƒå›´
            if (suggestion.start_date) {
                document.getElementById('startDate').value = suggestion.start_date.split(' ')[0];
            }
            if (suggestion.end_date) {
                document.getElementById('endDate').value = suggestion.end_date.split(' ')[0];
            }
            
            // å¦‚æœæœ‰ç°æœ‰æ•°æ®ï¼Œæ™ºèƒ½åˆå¹¶æ€»æ˜¯å¯ç”¨çš„
            if (suggestionsData.existing_data && suggestionsData.existing_data.length > 0) {
                document.getElementById('mergeWithExisting').checked = true;
            }
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success alert-dismissible fade show';
            successDiv.innerHTML = `
                <strong>âœ… å»ºè®®å·²åº”ç”¨!</strong> 
                å·²è‡ªåŠ¨å¡«å……ä¸‹è½½å‚æ•°ï¼š${suggestion.data_type} ${currentSymbol} ${currentTimeframe}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // æ’å…¥åˆ°è¡¨å•å‰é¢
            const form = document.getElementById('dataConfigForm');
            form.parentNode.insertBefore(successDiv, form);
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 3000);
            
        }, 500);
    });
}

// ä¸‹è½½çŠ¶æ€æ›´æ–°å‡½æ•°
async function updateDownloadStatus() {
    try {
        // è·å–æ‰€æœ‰ä¸‹è½½ä»»åŠ¡çš„çŠ¶æ€
        const response = await fetch('/api/data/downloads');
        const result = await response.json();
        
        if (result.success) {
            const downloads = result.data;
            updateDownloadProgress(downloads);
            updateDownloadHistory(downloads);
        }
    } catch (error) {
        console.error('æ›´æ–°ä¸‹è½½çŠ¶æ€å¤±è´¥:', error);
    }
}

function updateDownloadProgress(downloads) {
    const progressDiv = document.getElementById('downloadProgress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    const progressText = document.getElementById('progressText');
    
    // æŸ¥æ‰¾æ­£åœ¨è¿›è¡Œçš„ä¸‹è½½ä»»åŠ¡
    const activeDownload = downloads.find(d => d.status === 'downloading' || d.status === 'starting');
    
    if (activeDownload) {
        progressDiv.style.display = 'block';
        progressBar.style.width = `${activeDownload.progress}%`;
        progressText.textContent = activeDownload.message;
        
        // å¦‚æœæ˜¯æ‰¹é‡ä¸‹è½½ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
        if (activeDownload.type === 'batch') {
            progressText.innerHTML = `
                ${activeDownload.message}<br>
                <small class="text-muted">
                    è¿›åº¦: ${activeDownload.progress}% | 
                    å·²å®Œæˆ: ${activeDownload.completed_tasks || 0} | 
                    å¤±è´¥: ${activeDownload.failed_tasks || 0} | 
                    æ€»è®¡: ${activeDownload.total_tasks || 0}
                </small>
            `;
        }
    } else {
        progressDiv.style.display = 'none';
    }
}

function updateDownloadHistory(downloads) {
    const historyList = document.getElementById('historyList');
    
    if (!historyList) return;
    
    // æ¸…ç©ºç°æœ‰å†å²
    historyList.innerHTML = '';
    
    // æ˜¾ç¤ºæœ€è¿‘çš„ä¸‹è½½ä»»åŠ¡
    const recentDownloads = downloads.slice(-5).reverse();
    
    recentDownloads.forEach(download => {
        const listItem = document.createElement('div');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        
        let statusBadge = '';
        if (download.status === 'completed') {
            statusBadge = '<span class="badge bg-success">å®Œæˆ</span>';
        } else if (download.status === 'downloading') {
            statusBadge = '<span class="badge bg-primary">ä¸‹è½½ä¸­</span>';
        } else if (download.status === 'failed') {
            statusBadge = '<span class="badge bg-danger">å¤±è´¥</span>';
        } else if (download.status === 'starting') {
            statusBadge = '<span class="badge bg-warning">å¯åŠ¨ä¸­</span>';
        }
        
        let downloadInfo = '';
        if (download.type === 'batch') {
            downloadInfo = `æ‰¹é‡ä¸‹è½½ (${download.symbols?.length || 0}Ã—${download.timeframes?.length || 0})`;
        } else {
            downloadInfo = `${download.symbol} ${download.timeframe}`;
        }
        
        listItem.innerHTML = `
            <div>
                <strong>${downloadInfo}</strong><br>
                <small class="text-muted">${download.message}</small>
            </div>
            ${statusBadge}
        `;
        
        historyList.appendChild(listItem);
    });
    
    if (recentDownloads.length === 0) {
        historyList.innerHTML = '<div class="text-muted text-center">æš‚æ— ä¸‹è½½å†å²</div>';
    }
}

// å®šæœŸæ›´æ–°ä¸‹è½½çŠ¶æ€
setInterval(updateDownloadStatus, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡

// æ‰¹é‡ä¸‹è½½è¾…åŠ©å‡½æ•°
function selectAllSymbols() {
    const select = document.getElementById('batchSymbols');
    for (let option of select.options) {
        if (option.value) {  // è·³è¿‡ç©ºå€¼é€‰é¡¹
            option.selected = true;
        }
    }
    updateBatchSelectionStats();
}

function clearAllSymbols() {
    const select = document.getElementById('batchSymbols');
    for (let option of select.options) {
        option.selected = false;
    }
}

function selectAllTimeframes() {
    const select = document.getElementById('batchTimeframes');
    for (let option of select.options) {
        if (option.value) {  // è·³è¿‡ç©ºå€¼é€‰é¡¹
            option.selected = true;
        }
    }
    updateBatchSelectionStats();
}

function clearAllTimeframes() {
    const select = document.getElementById('batchTimeframes');
    for (let option of select.options) {
        option.selected = false;
    }
    updateBatchSelectionStats();
}

// æ›´æ–°æ‰¹é‡é€‰æ‹©ç»Ÿè®¡
function updateBatchSelectionStats() {
    const symbolsSelect = document.getElementById('batchSymbols');
    const timeframesSelect = document.getElementById('batchTimeframes');
    const statsSpan = document.getElementById('batchSelectionStats');
    
    if (!symbolsSelect || !timeframesSelect || !statsSpan) return;
    
    const selectedSymbols = Array.from(symbolsSelect.selectedOptions).filter(option => option.value).length;
    const selectedTimeframes = Array.from(timeframesSelect.selectedOptions).filter(option => option.value).length;
    const totalTasks = selectedSymbols * selectedTimeframes;
    
    if (selectedSymbols === 0 || selectedTimeframes === 0) {
        statsSpan.textContent = 'æœªé€‰æ‹©';
        statsSpan.className = 'text-muted';
    } else {
        statsSpan.textContent = `${selectedSymbols} ä¸ªäº¤æ˜“å¯¹ Ã— ${selectedTimeframes} ä¸ªæ—¶é—´æ¡†æ¶ = ${totalTasks} ä¸ªä»»åŠ¡`;
        statsSpan.className = 'text-success fw-bold';
    }
}

async function startBatchDownload() {
    const exchange = document.getElementById('exchange').value;
    const tradeType = document.getElementById('tradeType').value;
    const batchSymbols = Array.from(document.getElementById('batchSymbols').selectedOptions).map(option => option.value);
    const batchTimeframes = Array.from(document.getElementById('batchTimeframes').selectedOptions).map(option => option.value);
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!exchange || !tradeType) {
        alert('è¯·é€‰æ‹©äº¤æ˜“æ‰€å’Œäº¤æ˜“ç±»å‹');
        return;
    }
    
    if (batchSymbols.length === 0) {
        alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªäº¤æ˜“å¯¹');
        return;
    }
    
    if (batchTimeframes.length === 0) {
        alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ—¶é—´æ¡†æ¶');
        return;
    }
    
    if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
        return;
    }
    
    if (new Date(startDate) >= new Date(endDate)) {
        alert('å¼€å§‹æ—¥æœŸå¿…é¡»æ—©äºç»“æŸæ—¥æœŸ');
        return;
    }
    
    // è®¡ç®—æ€»ä»»åŠ¡æ•°
    const totalTasks = batchSymbols.length * batchTimeframes.length;
    
    // ç¡®è®¤å¯¹è¯æ¡†
    const confirmMessage = `ç¡®è®¤å¼€å§‹æ‰¹é‡ä¸‹è½½ï¼Ÿ\n\n` +
        `äº¤æ˜“æ‰€: ${exchange}\n` +
        `äº¤æ˜“ç±»å‹: ${tradeType}\n` +
        `äº¤æ˜“å¯¹: ${batchSymbols.join(', ')}\n` +
        `æ—¶é—´æ¡†æ¶: ${batchTimeframes.join(', ')}\n` +
        `æ—¶é—´èŒƒå›´: ${startDate} åˆ° ${endDate}\n` +
        `æ€»ä»»åŠ¡æ•°: ${totalTasks} ä¸ª\n\n` +
        `è¿™å°†å¯åŠ¨ ${totalTasks} ä¸ªä¸‹è½½ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // å‡†å¤‡æ‰¹é‡ä¸‹è½½æ•°æ®
    const batchDownloadData = {
        exchange: exchange,
        trade_type: tradeType,
        symbols: batchSymbols,
        timeframes: batchTimeframes,
        start_date: startDate,
        end_date: endDate
    };
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const batchButton = document.querySelector('button[onclick="startBatchDownload()"]');
        const originalText = batchButton.textContent;
        batchButton.textContent = 'ğŸ”„ æ­£åœ¨å¯åŠ¨...';
        batchButton.disabled = true;
        
        // å‘é€æ‰¹é‡ä¸‹è½½è¯·æ±‚
        const response = await fetch('/api/data/batch-download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(batchDownloadData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success alert-dismissible fade show';
            successDiv.innerHTML = `
                <strong>ğŸš€ æ‰¹é‡ä¸‹è½½å·²å¯åŠ¨!</strong><br>
                ä»»åŠ¡ID: ${result.data.id}<br>
                æ€»ä»»åŠ¡æ•°: ${result.data.total_tasks}<br>
                çŠ¶æ€: ${result.data.status}<br>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // æ’å…¥åˆ°è¡¨å•å‰é¢
            const form = document.getElementById('batchDownloadForm');
            form.parentNode.insertBefore(successDiv, form);
            
            // ç«‹å³æ›´æ–°ä¸‹è½½çŠ¶æ€
            if (typeof updateDownloadStatus === 'function') {
                updateDownloadStatus();
            }
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 3000);
            
        } else {
            alert(`æ‰¹é‡ä¸‹è½½å¯åŠ¨å¤±è´¥: ${result.error}`);
        }
        
    } catch (error) {
        console.error('æ‰¹é‡ä¸‹è½½è¯·æ±‚å¤±è´¥:', error);
        alert(`æ‰¹é‡ä¸‹è½½è¯·æ±‚å¤±è´¥: ${error.message}`);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const batchButton = document.querySelector('button[onclick="startBatchDownload()"]');
        batchButton.textContent = originalText;
        batchButton.disabled = false;
    }
}
</script>
{% endblock %} 