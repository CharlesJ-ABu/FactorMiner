{% extends "base.html" %}

{% block title %}æ•°æ®æŸ¥çœ‹ - {{ config.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>ğŸ“ æ•°æ®æŸ¥çœ‹</h2>
        <p class="text-muted">æŸ¥çœ‹æœ¬åœ°å­˜å‚¨çš„è¡Œæƒ…æ•°æ®</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>ğŸ“Š æœ¬åœ°æ•°æ®</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">ç­›é€‰äº¤æ˜“æ‰€</label>
                        <select class="form-select" id="filterExchange">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ç­›é€‰äº¤æ˜“å¯¹</label>
                        <select class="form-select" id="filterSymbol">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ç­›é€‰æ—¶é—´æ¡†æ¶</label>
                        <select class="form-select" id="filterTimeframe">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ç­›é€‰æ•°æ®ç±»å‹</label>
                        <select class="form-select" id="filterDataType">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-outline-primary w-100" onclick="refreshData()">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>äº¤æ˜“æ‰€</th>
                                <th>äº¤æ˜“å¯¹</th>
                                <th>æ—¶é—´æ¡†æ¶</th>
                                <th>æ•°æ®ç±»å‹</th>
                                <th>æ•°æ®èŒƒå›´</th>
                                <th>æ•°æ®ç‚¹æ•°</th>
                                <th>æ–‡ä»¶å¤§å°</th>
                                <th>æœ€åä¿®æ”¹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                            <!-- æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ•°æ®æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div class="modal fade" id="dataViewModal" tabindex="-1" aria-labelledby="dataViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-xl-down" style="max-width: 95vw; margin: 1rem auto; height: 95vh;">
        <div class="modal-content" style="height: 100%;">
            <div class="modal-header">
                <h5 class="modal-title" id="dataViewModalLabel">ğŸ“Š æ•°æ®æŸ¥çœ‹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: calc(100% - 120px); overflow-y: auto;">
                <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
                <ul class="nav nav-tabs" id="dataViewTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="kline-tab" data-bs-toggle="tab" data-bs-target="#kline-content" type="button" role="tab">
                            ğŸ“ˆ Kçº¿å›¾
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-content" type="button" role="tab">
                            ğŸ“‹ è¡Œæƒ…æ•°æ®
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="meta-tab" data-bs-toggle="tab" data-bs-target="#meta-content" type="button" role="tab">
                            â„¹ï¸ Metaä¿¡æ¯
                        </button>
                    </li>
                </ul>
                
                <!-- æ ‡ç­¾é¡µå†…å®¹ -->
                <div class="tab-content" id="dataViewTabContent">
                    <!-- Kçº¿å›¾æ ‡ç­¾é¡µ -->
                    <div class="tab-pane fade show active" id="kline-content" role="tabpanel">
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="row align-items-center">
                                            <div class="col-md-6">
                                                <h6 class="mb-0">ğŸ“ˆ Kçº¿å›¾</h6>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex gap-2 justify-content-end">
                                                    <select class="form-select form-select-sm" id="factorSelect" style="max-width: 200px;">
                                                        <option value="">é€‰æ‹©å› å­...</option>
                                                    </select>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="addFactor()">
                                                        â• æ·»åŠ å› å­
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary" onclick="clearFactors()">
                                                        ğŸ—‘ï¸ æ¸…ç©ºå› å­
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body p-3" style="min-height: 560px;">
                                        <div id="klineChart" style="width: 100% !important; height: 540px; max-height: 540px; overflow: hidden; border: 1px solid #e9ecef; border-radius: 4px; min-width: 100%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å·²é€‰å› å­åˆ—è¡¨ -->
                        <div class="row mt-2" id="selectedFactorsRow" style="display: none;">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body p-2">
                                        <div class="d-flex flex-wrap gap-2" id="selectedFactorsList">
                                            <!-- å·²é€‰å› å­æ ‡ç­¾å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¡Œæƒ…æ•°æ®æ ‡ç­¾é¡µ -->
                    <div class="tab-pane fade" id="data-content" role="tabpanel">
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6>è¡Œæƒ…æ•°æ®è¡¨æ ¼</h6>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="exportData('csv')">
                                            ğŸ“¥ å¯¼å‡ºCSV
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="exportData('excel')">
                                            ğŸ“¥ å¯¼å‡ºExcel
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped" id="dataTable">
                                        <thead>
                                            <tr>
                                                <th>æ—¶é—´</th>
                                                <th>å¼€ç›˜ä»·</th>
                                                <th>æœ€é«˜ä»·</th>
                                                <th>æœ€ä½ä»·</th>
                                                <th>æ”¶ç›˜ä»·</th>
                                                <th>æˆäº¤é‡</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dataTableBody">
                                            <!-- æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Metaä¿¡æ¯æ ‡ç­¾é¡µ -->
                    <div class="tab-pane fade" id="meta-content" role="tabpanel">
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div id="metaInfo">
                                            <!-- Metaä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<!-- å¼•å…¥Plotly.js - ä¸“ä¸šçš„å›¾è¡¨åº“ï¼Œæ”¯æŒçœŸæ­£çš„Kçº¿å›¾ -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
// å…¨å±€å˜é‡
let selectedFactors = []; // å­˜å‚¨å·²é€‰æ‹©çš„å› å­
let availableFactors = []; // å­˜å‚¨å¯ç”¨çš„å› å­åˆ—è¡¨

document.addEventListener('DOMContentLoaded', function() {
    console.log('æ•°æ®æŸ¥çœ‹é¡µé¢åˆå§‹åŒ–');
    
    // æ£€æŸ¥Plotlyæ˜¯å¦æ­£ç¡®åŠ è½½
    console.log('ğŸ” æ£€æŸ¥Plotlyåº“åŠ è½½çŠ¶æ€...');
    console.log('ğŸ” Plotly å¯¹è±¡ç±»å‹:', typeof Plotly);
    console.log('ğŸ” Plotly å¯¹è±¡:', Plotly);
    
    if (typeof Plotly === 'undefined') {
        console.error('âŒ Plotly åº“æœªåŠ è½½! è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–CDNçŠ¶æ€');
        // å°è¯•é‡æ–°åŠ è½½Plotly
        console.log('ğŸ” å°è¯•é‡æ–°åŠ è½½Plotly...');
        loadPlotly();
    } else {
        console.log('âœ… Plotly åº“å·²æ­£ç¡®åŠ è½½');
    }
    
    loadLocalData();
    loadAvailableFactors(); // åŠ è½½å¯ç”¨å› å­åˆ—è¡¨
    
    // æ·»åŠ ç­›é€‰å™¨äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('filterExchange').addEventListener('change', function() {
        displayData(window.currentData || []);
    });
    document.getElementById('filterSymbol').addEventListener('change', function() {
        displayData(window.currentData || []);
    });
    document.getElementById('filterDataType').addEventListener('change', function() {
        displayData(window.currentData || []);
    });
});

// åŠ è½½å¯ç”¨å› å­åˆ—è¡¨
async function loadAvailableFactors() {
    try {
        const response = await fetch('/api/factors/list');
        const result = await response.json();
        
        if (result.success) {
            availableFactors = result.factors || [];
            updateFactorSelect();
        } else {
            console.error('åŠ è½½å› å­åˆ—è¡¨å¤±è´¥:', result.error);
        }
    } catch (error) {
        console.error('åŠ è½½å› å­åˆ—è¡¨å¤±è´¥:', error);
    }
}

// æ›´æ–°å› å­é€‰æ‹©å™¨
function updateFactorSelect() {
    const factorSelect = document.getElementById('factorSelect');
    if (!factorSelect) return;
    
    // æ¸…ç©ºç°æœ‰é€‰é¡¹
    factorSelect.innerHTML = '<option value="">é€‰æ‹©å› å­...</option>';
    
    // æ·»åŠ å¯ç”¨å› å­
    availableFactors.forEach(factor => {
        const option = document.createElement('option');
        option.value = factor.id;
        option.textContent = `${factor.name} (${factor.type || 'æœªçŸ¥ç±»å‹'})`;
        factorSelect.appendChild(option);
    });
}

// æ·»åŠ å› å­åˆ°å›¾è¡¨
function addFactor() {
    const factorSelect = document.getElementById('factorSelect');
    const factorId = factorSelect.value;
    
    if (!factorId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå› å­');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ 
    if (selectedFactors.find(f => f.id === factorId)) {
        alert('è¯¥å› å­å·²ç»æ·»åŠ è¿‡äº†');
        return;
    }
    
    // æ‰¾åˆ°å› å­ä¿¡æ¯
    const factor = availableFactors.find(f => f.id === factorId);
    if (!factor) {
        alert('æ‰¾ä¸åˆ°å› å­ä¿¡æ¯');
        return;
    }
    
    // æ·»åŠ åˆ°å·²é€‰åˆ—è¡¨
    selectedFactors.push({
        id: factorId,
        name: factor.name,
        type: factor.type || 'æœªçŸ¥ç±»å‹'
    });
    
    // æ›´æ–°UI
    updateSelectedFactorsUI();
    
    // é‡æ–°ç»˜åˆ¶å›¾è¡¨
    if (window.currentOHLCVData) {
        renderKlineChart(window.currentOHLCVData);
    }
    
    // æ¸…ç©ºé€‰æ‹©å™¨
    factorSelect.value = '';
}

// ä»å›¾è¡¨ä¸­ç§»é™¤å› å­
function removeFactor(factorId) {
    selectedFactors = selectedFactors.filter(f => f.id !== factorId);
    updateSelectedFactorsUI();
    
    // é‡æ–°ç»˜åˆ¶å›¾è¡¨
    if (window.currentOHLCVData) {
        renderKlineChart(window.currentOHLCVData);
    }
}

// æ¸…ç©ºæ‰€æœ‰å› å­
function clearFactors() {
    selectedFactors = [];
    updateSelectedFactorsUI();
    
    // é‡æ–°ç»˜åˆ¶å›¾è¡¨
    if (window.currentOHLCVData) {
        renderKlineChart(window.currentOHLCVData);
    }
}

// æ›´æ–°å·²é€‰å› å­UI
function updateSelectedFactorsUI() {
    const selectedFactorsRow = document.getElementById('selectedFactorsRow');
    const selectedFactorsList = document.getElementById('selectedFactorsList');
    
    if (!selectedFactorsRow || !selectedFactorsList) return;
    
    if (selectedFactors.length === 0) {
        selectedFactorsRow.style.display = 'none';
        return;
    }
    
    selectedFactorsRow.style.display = 'block';
    selectedFactorsList.innerHTML = '';
    
    selectedFactors.forEach(factor => {
        const factorTag = document.createElement('span');
        factorTag.className = 'badge bg-primary me-2 mb-1';
        factorTag.innerHTML = `
            ${factor.name}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    onclick="removeFactor('${factor.id}')" 
                    style="font-size: 0.5rem;"></button>
        `;
        selectedFactorsList.appendChild(factorTag);
    });
}

// åŠ¨æ€åŠ è½½Plotlyçš„å‡½æ•°
function loadPlotly() {
    console.log('ğŸ” å¼€å§‹åŠ¨æ€åŠ è½½Plotly...');
    
    // åˆ›å»ºscriptæ ‡ç­¾ - ä½¿ç”¨æ›´ç¨³å®šçš„CDN
    const plotlyScript = document.createElement('script');
    plotlyScript.src = 'https://cdn.plot.ly/plotly-latest.min.js';
    plotlyScript.onload = function() {
        console.log('âœ… Plotly åº“åŠ è½½æˆåŠŸ');
        console.log('ğŸ” ç°åœ¨Plotlyåº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†');
    };
    plotlyScript.onerror = function() {
        console.error('âŒ Plotly ä¸»åº“åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
        // å¤‡ç”¨CDN
        loadPlotlyBackup();
    };
    
    document.head.appendChild(plotlyScript);
}

function loadPlotlyBackup() {
    console.log('ğŸ” å°è¯•å¤‡ç”¨CDN...');
    
    const backupScript = document.createElement('script');
    backupScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.27.1/plotly.min.js';
    backupScript.onload = function() {
        console.log('âœ… Plotly å¤‡ç”¨CDNåŠ è½½æˆåŠŸ');
    };
    backupScript.onerror = function() {
        console.error('âŒ æ‰€æœ‰Plotly CDNéƒ½åŠ è½½å¤±è´¥');
    };
    
    document.head.appendChild(backupScript);
}

async function loadLocalData() {
    try {
        const response = await fetch('/api/data/local-data');
        const result = await response.json();
        
        if (result.success) {
            window.currentData = result.data; // ä¿å­˜åˆ°å…¨å±€å˜é‡
            displayData(result.data);
            updateFilters(result.data);
        } else {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', result.error);
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    }
}

function displayData(data) {
    const tbody = document.getElementById('dataTable');
    tbody.innerHTML = '';
    
    // åº”ç”¨ç­›é€‰
    const filteredData = filterData(data);
    
    if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    filteredData.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.exchange.toUpperCase()}</td>
            <td>${item.symbol}</td>
            <td>${item.timeframe}</td>
            <td>${item.data_type || 'unknown'}</td>
            <td>${item.date_range.start} åˆ° ${item.date_range.end}</td>
            <td>${item.data_points.toLocaleString()}</td>
            <td>${item.file_size}</td>
            <td>${item.last_modified}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewData('${item.file_path}')">
                    ğŸ‘ï¸ æŸ¥çœ‹
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteData('${item.file_path}')">
                    ğŸ—‘ï¸ åˆ é™¤
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function filterData(data) {
    const exchangeFilter = document.getElementById('filterExchange').value;
    const symbolFilter = document.getElementById('filterSymbol').value;
    const timeframeFilter = document.getElementById('filterTimeframe').value;
    const dataTypeFilter = document.getElementById('filterDataType').value;
    
    return data.filter(item => {
        const exchangeMatch = !exchangeFilter || item.exchange === exchangeFilter;
        const symbolMatch = !symbolFilter || item.symbol === symbolFilter;
        const timeframeMatch = !timeframeFilter || item.timeframe === timeframeFilter;
        const dataTypeMatch = !dataTypeFilter || (item.data_type || 'unknown') === dataTypeFilter;
        
        return exchangeMatch && symbolMatch && timeframeMatch && dataTypeMatch;
    });
}

function updateFilters(data) {
    const exchanges = [...new Set(data.map(item => item.exchange))];
    const symbols = [...new Set(data.map(item => item.symbol))];
    const timeframes = [...new Set(data.map(item => item.timeframe))];
    const dataTypes = [...new Set(data.map(item => item.data_type || 'unknown'))];
    
    // æ›´æ–°äº¤æ˜“æ‰€ç­›é€‰
    const exchangeFilter = document.getElementById('filterExchange');
    exchangeFilter.innerHTML = '<option value="">å…¨éƒ¨</option>';
    exchanges.forEach(exchange => {
        const option = document.createElement('option');
        option.value = exchange;
        option.textContent = exchange.toUpperCase();
        exchangeFilter.appendChild(option);
    });
    
    // æ›´æ–°äº¤æ˜“å¯¹ç­›é€‰
    const symbolFilter = document.getElementById('filterSymbol');
    symbolFilter.innerHTML = '<option value="">å…¨éƒ¨</option>';
    symbols.forEach(symbol => {
        const option = document.createElement('option');
        option.value = symbol;
        option.textContent = symbol;
        symbolFilter.appendChild(option);
    });
    
    // æ›´æ–°æ—¶é—´æ¡†æ¶ç­›é€‰
    const timeframeFilter = document.getElementById('filterTimeframe');
    timeframeFilter.innerHTML = '<option value="">å…¨éƒ¨</option>';
    timeframes.forEach(timeframe => {
        const option = document.createElement('option');
        option.value = timeframe;
        option.textContent = timeframe;
        timeframeFilter.appendChild(option);
    });
    
    // æ›´æ–°æ•°æ®ç±»å‹ç­›é€‰
    const dataTypeFilter = document.getElementById('filterDataType');
    dataTypeFilter.innerHTML = '<option value="">å…¨éƒ¨</option>';
    dataTypes.forEach(dataType => {
        const option = document.createElement('option');
        option.value = dataType;
        option.textContent = dataType;
        dataTypeFilter.appendChild(option);
    });
}

function refreshData() {
    loadLocalData();
}

function viewData(filePath) {
    console.log('æŸ¥çœ‹æ•°æ®:', filePath);
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('dataViewModal'));
    modal.show();
    
    // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
    document.getElementById('dataViewModalLabel').textContent = 'ğŸ“Š æ•°æ®æŸ¥çœ‹ - åŠ è½½ä¸­...';
    
    // åŠ è½½æ•°æ®
    loadDataForView(filePath);
}

async function loadDataForView(filePath) {
    try {
        // è°ƒç”¨APIè·å–æ•°æ®
        const response = await fetch('/api/data/view-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ file_path: filePath })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
            document.getElementById('dataViewModalLabel').textContent = `ğŸ“Š æ•°æ®æŸ¥çœ‹ - ${result.data.symbol} ${result.data.timeframe}`;
            
            // æ˜¾ç¤ºæ•°æ®å†…å®¹
            displayDataInModal(result.data);
        } else {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', result.error);
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯åœ¨Kçº¿å›¾åŒºåŸŸ
            const klineChart = document.getElementById('klineChart');
            if (klineChart) {
                klineChart.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>âŒ åŠ è½½å¤±è´¥</h6>
                        <p>${result.error}</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯åœ¨Kçº¿å›¾åŒºåŸŸ
        const klineChart = document.getElementById('klineChart');
        if (klineChart) {
            klineChart.innerHTML = `
                <div class="alert alert-danger">
                    <h6>âŒ åŠ è½½å¤±è´¥</h6>
                    <p>${error.message}</p>
                </div>
            `;
        }
    }
}

function displayDataInModal(data) {
    console.log('ğŸ” displayDataInModal å¼€å§‹æ‰§è¡Œ');
    console.log('ğŸ“Š æ¥æ”¶åˆ°çš„æ•°æ®:', data);
    console.log('ğŸ“Š æ•°æ®ç±»å‹:', typeof data);
    console.log('ğŸ“Š æ•°æ®é”®:', Object.keys(data));
    
    // ç›´æ¥ä½¿ç”¨ç°æœ‰çš„æ ‡ç­¾é¡µç»“æ„ï¼Œä¸éœ€è¦åˆ›å»ºHTML
    console.log('ğŸ” ä½¿ç”¨ç°æœ‰çš„æ ‡ç­¾é¡µç»“æ„');
    
    // æ¸²æŸ“Kçº¿å›¾
    console.log('ğŸ” å‡†å¤‡è°ƒç”¨renderKlineChart...');
    console.log('ğŸ” ohlcv_data:', data.ohlcv_data);
    renderKlineChart(data.ohlcv_data);
    
    // æ¸²æŸ“æ•°æ®è¡¨æ ¼
    console.log('ğŸ” å‡†å¤‡è°ƒç”¨renderDataTable...');
    renderDataTable(data.ohlcv_data);
    
    // æ¸²æŸ“Metaä¿¡æ¯
    console.log('ğŸ” å‡†å¤‡è°ƒç”¨renderMetaInfo...');
    renderMetaInfo(data);
}

// æ¸²æŸ“Kçº¿å›¾ - ä½¿ç”¨Plotlyåˆ›å»ºçœŸæ­£çš„Kçº¿å›¾ï¼Œæ”¯æŒå› å­å åŠ 
async function renderKlineChart(ohlcvData) {
    console.log('ğŸ” renderKlineChart å¼€å§‹æ‰§è¡Œ');
    console.log('ğŸ“Š æ¥æ”¶åˆ°çš„æ•°æ®:', ohlcvData);
    console.log('ğŸ“Š æ•°æ®ç±»å‹:', typeof ohlcvData);
    console.log('ğŸ“Š æ•°æ®é•¿åº¦:', ohlcvData ? ohlcvData.length : 'undefined');
    
    if (!ohlcvData || !Array.isArray(ohlcvData)) {
        console.error('âŒ ohlcvData ä¸æ˜¯æ•°ç»„æˆ–ä¸ºç©º:', ohlcvData);
        return;
    }
    
    if (ohlcvData.length === 0) {
        console.warn('âš ï¸ ohlcvData é•¿åº¦ä¸º0');
        return;
    }
    
    // ä¿å­˜æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾›å› å­è®¡ç®—ä½¿ç”¨
    window.currentOHLCVData = ohlcvData;
    
    // æ£€æŸ¥ç¬¬ä¸€æ¡æ•°æ®çš„ç»“æ„
    console.log('ğŸ” ç¬¬ä¸€æ¡æ•°æ®ç»“æ„:', ohlcvData[0]);
    console.log('ğŸ” ç¬¬ä¸€æ¡æ•°æ®çš„æ‰€æœ‰é”®:', Object.keys(ohlcvData[0]));
    
    const chartContainer = document.getElementById('klineChart');
    console.log('ğŸ” å›¾è¡¨å®¹å™¨å…ƒç´ :', chartContainer);
    
    if (!chartContainer) {
        console.error('âŒ æ‰¾ä¸åˆ°klineChartå®¹å™¨å…ƒç´ ');
        return;
    }
    
    // æ£€æŸ¥Plotlyæ˜¯å¦æ­£ç¡®åŠ è½½
    if (typeof Plotly === 'undefined') {
        console.error('âŒ Plotly åº“æœªåŠ è½½!');
        return;
    }
    
    console.log('ğŸ” Plotly åº“å·²åŠ è½½:', typeof Plotly);
    
    // å‡†å¤‡æ•°æ®
    console.log('ğŸ” å¼€å§‹å‡†å¤‡Kçº¿å›¾æ•°æ®...');
    
    // æå–OHLCVæ•°æ®
    const times = ohlcvData.map(item => item.timestamp);
    const opens = ohlcvData.map(item => item.open);
    const highs = ohlcvData.map(item => item.high);
    const lows = ohlcvData.map(item => item.low);
    const closes = ohlcvData.map(item => item.close);
    const volumes = ohlcvData.map(item => item.volume);
    
    console.log('ğŸ” æ—¶é—´æ•°æ®æ•°é‡:', times.length);
    console.log('ğŸ” å¼€ç›˜ä»·æ•°é‡:', opens.length);
    console.log('ğŸ” æœ€é«˜ä»·æ•°é‡:', highs.length);
    console.log('ğŸ” æœ€ä½ä»·æ•°é‡:', lows.length);
    console.log('ğŸ” æ”¶ç›˜ä»·æ•°é‡:', closes.length);
    console.log('ğŸ” æˆäº¤é‡æ•°é‡:', volumes.length);
    
    // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
    const validData = times.filter((_, index) => 
        opens[index] !== null && highs[index] !== null && 
        lows[index] !== null && closes[index] !== null
    );
    
    console.log('ğŸ” æœ‰æ•ˆæ•°æ®æ•°é‡:', validData.length);
    
    if (validData.length === 0) {
        console.error('âŒ æ²¡æœ‰æœ‰æ•ˆçš„OHLCVæ•°æ®');
        return;
    }
    
    // åˆ›å»ºKçº¿å›¾æ•°æ®
    const candlestickData = [{
        type: 'candlestick',
        x: times,
        open: opens,
        high: highs,
        low: lows,
        close: closes,
        name: 'Kçº¿å›¾',
        increasing: {
            line: { color: '#26a69a' },
            fillcolor: '#26a69a'
        },
        decreasing: {
            line: { color: '#ef5350' },
            fillcolor: '#ef5350'
        }
    }];
    
    // åˆ›å»ºæˆäº¤é‡å›¾æ•°æ®
    const volumeData = [{
        type: 'bar',
        x: times,
        y: volumes,
        name: 'æˆäº¤é‡',
        yaxis: 'y2',
        marker: {
            color: 'rgba(0,100,80,0.7)'
        },
        opacity: 0.8
    }];
    
    // å‡†å¤‡å› å­æ•°æ®
    const factorData = await prepareFactorData(ohlcvData);
    
    // åˆå¹¶æ‰€æœ‰æ•°æ®
    const allData = [...candlestickData, ...volumeData, ...factorData];
    
    // å›¾è¡¨å¸ƒå±€é…ç½®
    const layout = {
        title: {
            text: 'Kçº¿å›¾ (UTCæ—¶é—´)',
            font: { size: 16 }
        },
        xaxis: {
            title: 'æ—¶é—´ (UTC)',
            type: 'date',
            rangeslider: { visible: false }
        },
        yaxis: {
            title: 'ä»·æ ¼',
            side: 'left',
            domain: [0.4, 1]  // Kçº¿å›¾å æ®60%çš„é«˜åº¦
        },
        yaxis2: {
            title: 'æˆäº¤é‡',
            side: 'left',
            domain: [0.2, 0.35],  // æˆäº¤é‡å æ®15%çš„é«˜åº¦
            overlaying: false    // ä¸é‡å ï¼Œç‹¬ç«‹æ˜¾ç¤º
        },
        yaxis3: {
            title: 'å› å­å€¼',
            side: 'right',
            domain: [0.4, 1],  // å› å­å€¼ä¸Kçº¿å›¾å…±äº«é«˜åº¦ï¼Œä½†ä½¿ç”¨å³ä¾§yè½´
            overlaying: 'y',    // ä¸ä¸»yè½´é‡å 
            anchor: 'x',
            position: 1
        },
        height: null, // è®©é«˜åº¦è‡ªåŠ¨é€‚åº”å®¹å™¨
        width: null, // è®©å®½åº¦è‡ªåŠ¨é€‚åº”å®¹å™¨
        margin: { l: 40, r: 60, t: 40, b: 40 }, // å³ä¾§ç•™æ›´å¤šç©ºé—´ç»™å› å­yè½´
        showlegend: true,
        legend: { x: 0, y: 1 },
        autosize: true,
        fitToContainer: true
    };
    
    console.log('ğŸ” å¼€å§‹åˆ›å»ºPlotly Kçº¿å›¾...');
    console.log('ğŸ” å›¾è¡¨æ•°æ®:', allData);
    console.log('ğŸ” å›¾è¡¨å¸ƒå±€:', layout);
    
    try {
        // é”€æ¯æ—§å›¾è¡¨
        if (window.klineChart) {
            console.log('ğŸ” é”€æ¯æ—§å›¾è¡¨');
            Plotly.purge(chartContainer);
        }
        
        // åˆ›å»ºæ–°å›¾è¡¨
        Plotly.newPlot(chartContainer, allData, layout, {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
            useResizeHandler: true,
            autosize: true
        });
        
        // ç¡®ä¿å›¾è¡¨é€‚åº”å®¹å™¨å¤§å°
        window.addEventListener('resize', function() {
            Plotly.Plots.resize(chartContainer);
        });
        
        // å¼ºåˆ¶é‡æ–°è®¡ç®—å›¾è¡¨å¤§å°
        setTimeout(function() {
            Plotly.Plots.resize(chartContainer);
        }, 100);
        
        console.log('âœ… Plotly Kçº¿å›¾åˆ›å»ºæˆåŠŸ!');
        window.klineChart = chartContainer;
        
    } catch (error) {
        console.error('âŒ åˆ›å»ºPlotly Kçº¿å›¾å¤±è´¥:', error);
        console.error('âŒ é”™è¯¯è¯¦æƒ…:', error.stack);
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        chartContainer.innerHTML = `
            <div class="alert alert-danger">
                <h6>âŒ Kçº¿å›¾åˆ›å»ºå¤±è´¥</h6>
                <p>${error.message}</p>
                <p>è¯·æ£€æŸ¥æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®</p>
            </div>
        `;
    }
}

// å‡†å¤‡å› å­æ•°æ®
async function prepareFactorData(ohlcvData) {
    if (!selectedFactors || selectedFactors.length === 0) {
        return [];
    }
    
    const factorData = [];
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
    
    for (let i = 0; i < selectedFactors.length; i++) {
        const factor = selectedFactors[i];
        const color = colors[i % colors.length];
        
        try {
            console.log(`ğŸ” å¼€å§‹è®¡ç®—å› å­: ${factor.name}`);
            // è®¡ç®—å› å­å€¼
            const factorValues = await calculateFactor(factor.id, ohlcvData);
            console.log(`ğŸ” å› å­ ${factor.name} è®¡ç®—ç»“æœ:`, factorValues ? factorValues.length : 'null');
            
            if (factorValues && factorValues.length > 0) {
                console.log(`ğŸ” åˆ›å»ºå› å­çº¿å›¾: ${factor.name}`);
                // åˆ›å»ºå› å­çº¿å›¾
                const factorTrace = {
                    type: 'scatter',
                    mode: 'lines',
                    x: ohlcvData.map(item => item.timestamp),
                    y: factorValues,
                    name: factor.name,
                    line: {
                        color: color,
                        width: 2
                    },
                    opacity: 0.8,
                    yaxis: 'y3', // ä½¿ç”¨ç¬¬ä¸‰ä¸ªyè½´ï¼Œé¿å…ä¸ä»·æ ¼å’Œæˆäº¤é‡é‡å 
                    showlegend: true
                };
                
                factorData.push(factorTrace);
                console.log(`âœ… å› å­ ${factor.name} çº¿å›¾åˆ›å»ºæˆåŠŸ`);
            } else {
                console.warn(`âš ï¸ å› å­ ${factor.name} æ²¡æœ‰æœ‰æ•ˆæ•°æ®`);
            }
        } catch (error) {
            console.error(`âŒ è®¡ç®—å› å­ ${factor.name} å¤±è´¥:`, error);
        }
    }
    
    return factorData;
}

// è®¡ç®—å•ä¸ªå› å­çš„å€¼
async function calculateFactor(factorId, ohlcvData) {
    try {
        // å‡†å¤‡æ•°æ®æ ¼å¼ - ç›´æ¥ä½¿ç”¨æ­£ç¡®çš„æ ¼å¼
        const marketData = {
            open: ohlcvData.map(item => item.open),
            high: ohlcvData.map(item => item.high),
            low: ohlcvData.map(item => item.low),
            close: ohlcvData.map(item => item.close),
            volume: ohlcvData.map(item => item.volume)
        };
        
        console.log(`ğŸ” å‘é€å¸‚åœºæ•°æ®: ${marketData.close.length} ä¸ªæ”¶ç›˜ä»·`);
        
        // è°ƒç”¨å› å­è®¡ç®—API
        const response = await fetch('/api/factors/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                factor_id: factorId,
                data: marketData,
                parameters: {}
            })
        });
        
        const result = await response.json();
        console.log(`ğŸ” APIå“åº”:`, result);
        
        if (result.success) {
            console.log(`âœ… å› å­è®¡ç®—æˆåŠŸï¼Œè¿”å› ${result.factor_values.length} ä¸ªå€¼`);
            return result.factor_values;
        } else {
            console.error(`âŒ å› å­ ${factorId} è®¡ç®—å¤±è´¥:`, result.error);
            return null;
        }
    } catch (error) {
        console.error(`è®¡ç®—å› å­ ${factorId} æ—¶å‡ºé”™:`, error);
        return null;
    }
}

// æ¸²æŸ“æ•°æ®è¡¨æ ¼
function renderDataTable(ohlcvData) {
    const tbody = document.getElementById('dataTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // åªæ˜¾ç¤ºå‰100æ¡æ•°æ®ï¼Œé¿å…é¡µé¢è¿‡é•¿
    const displayData = ohlcvData.slice(0, 100);
    
    displayData.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date(item.timestamp).toLocaleString()}</td>
            <td>${item.open?.toFixed(4) || 'N/A'}</td>
            <td>${item.high?.toFixed(4) || 'N/A'}</td>
            <td>${item.low?.toFixed(4) || 'N/A'}</td>
            <td>${item.close?.toFixed(4) || 'N/A'}</td>
            <td>${item.volume?.toLocaleString() || 'N/A'}</td>
        `;
        tbody.appendChild(row);
    });
    
    if (ohlcvData.length > 100) {
        const infoRow = document.createElement('tr');
        infoRow.innerHTML = `
            <td colspan="6" class="text-center text-muted">
                æ˜¾ç¤ºå‰100æ¡æ•°æ®ï¼Œå…±${ohlcvData.length}æ¡
            </td>
        `;
        tbody.appendChild(infoRow);
    }
}

// æ¸²æŸ“Metaä¿¡æ¯
function renderMetaInfo(data) {
    const metaInfo = document.getElementById('metaInfo');
    if (!metaInfo) return;
    
    const ohlcvData = data.ohlcv_data;
    if (!ohlcvData || ohlcvData.length === 0) {
        metaInfo.innerHTML = '<p class="text-muted">æš‚æ— æ•°æ®</p>';
        return;
    }
    
    // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
    const prices = ohlcvData.map(item => item.close).filter(p => p !== null && !isNaN(p));
    const volumes = ohlcvData.map(item => item.volume).filter(v => v !== null && !isNaN(v));
    
    const priceStats = {
        min: Math.min(...prices),
        max: Math.max(...prices),
        avg: prices.reduce((a, b) => a + b, 0) / prices.length
    };
    
    const volumeStats = {
        min: Math.min(...volumes),
        max: Math.max(...volumes),
        avg: volumes.reduce((a, b) => a + b, 0) / volumes.length
    };
    
    metaInfo.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>ğŸ“Š åŸºæœ¬ä¿¡æ¯</h6>
                <ul class="list-unstyled">
                    <li><strong>äº¤æ˜“å¯¹:</strong> ${data.symbol}</li>
                    <li><strong>æ—¶é—´æ¡†æ¶:</strong> ${data.timeframe}</li>
                    <li><strong>æ•°æ®ç‚¹æ•°:</strong> ${ohlcvData.length.toLocaleString()}</li>
                    <li><strong>æ—¶é—´èŒƒå›´:</strong> ${new Date(ohlcvData[0].timestamp).toLocaleDateString()} åˆ° ${new Date(ohlcvData[ohlcvData.length-1].timestamp).toLocaleDateString()}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>ğŸ’° ä»·æ ¼ç»Ÿè®¡</h6>
                <ul class="list-unstyled">
                    <li><strong>æœ€ä½ä»·:</strong> ${priceStats.min?.toFixed(4) || 'N/A'}</li>
                    <li><strong>æœ€é«˜ä»·:</strong> ${priceStats.max?.toFixed(4) || 'N/A'}</li>
                    <li><strong>å¹³å‡ä»·:</strong> ${priceStats.avg?.toFixed(4) || 'N/A'}</li>
                    <li><strong>ä»·æ ¼æ³¢åŠ¨:</strong> ${((priceStats.max - priceStats.min) / priceStats.avg * 100).toFixed(2)}%</li>
                </ul>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <h6>ğŸ“ˆ æˆäº¤é‡ç»Ÿè®¡</h6>
                <ul class="list-unstyled">
                    <li><strong>æœ€å°æˆäº¤é‡:</strong> ${volumeStats.min?.toLocaleString() || 'N/A'}</li>
                    <li><strong>æœ€å¤§æˆäº¤é‡:</strong> ${volumeStats.max?.toLocaleString() || 'N/A'}</li>
                    <li><strong>å¹³å‡æˆäº¤é‡:</strong> ${volumeStats.avg?.toLocaleString() || 'N/A'}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>ğŸ” æ•°æ®è´¨é‡</h6>
                <ul class="list-unstyled">
                    <li><strong>å®Œæ•´åº¦:</strong> ${((ohlcvData.filter(item => item.open && item.high && item.low && item.close && item.volume).length / ohlcvData.length) * 100).toFixed(1)}%</li>
                    <li><strong>æ–‡ä»¶å¤§å°:</strong> ${data.file_size || 'N/A'}</li>
                    <li><strong>æœ€åæ›´æ–°:</strong> ${data.last_modified || 'N/A'}</li>
                </ul>
            </div>
        </div>
    `;
}

// å¯¼å‡ºæ•°æ®
function exportData(format) {
    // TODO: å®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½
    alert(`å¯¼å‡º${format.toUpperCase()}åŠŸèƒ½å¼€å‘ä¸­...`);
}

function deleteData(filePath) {
    if (confirm(`ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ•°æ®æ–‡ä»¶å—ï¼Ÿ\n${filePath}`)) {
        fetch('/api/data/delete-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ file_path: filePath })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('æ•°æ®åˆ é™¤æˆåŠŸ');
                loadLocalData();
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + result.error);
            }
        })
        .catch(error => {
            console.error('åˆ é™¤å¤±è´¥:', error);
            alert('åˆ é™¤å¤±è´¥: ' + error.message);
        });
    }
}
</script>
{% endblock %} 