{% extends "base.html" %}

{% block title %}æ•°æ®æŸ¥çœ‹ - {{ config.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>ğŸ“ æ•°æ®æŸ¥çœ‹</h2>
        <p class="text-muted">æŸ¥çœ‹æœ¬åœ°å­˜å‚¨çš„è¡Œæƒ…æ•°æ®</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>ğŸ“Š æœ¬åœ°æ•°æ®</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">ç­›é€‰äº¤æ˜“æ‰€</label>
                        <select class="form-select" id="filterExchange">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ç­›é€‰äº¤æ˜“å¯¹</label>
                        <select class="form-select" id="filterSymbol">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ç­›é€‰æ—¶é—´æ¡†æ¶</label>
                        <select class="form-select" id="filterTimeframe">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ç­›é€‰æ•°æ®ç±»å‹</label>
                        <select class="form-select" id="filterDataType">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-outline-primary w-100" onclick="refreshData()">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>äº¤æ˜“æ‰€</th>
                                <th>äº¤æ˜“å¯¹</th>
                                <th>æ—¶é—´æ¡†æ¶</th>
                                <th>æ•°æ®ç±»å‹</th>
                                <th>æ•°æ®èŒƒå›´</th>
                                <th>æ•°æ®ç‚¹æ•°</th>
                                <th>æ–‡ä»¶å¤§å°</th>
                                <th>æœ€åä¿®æ”¹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                            <!-- æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('æ•°æ®æŸ¥çœ‹é¡µé¢åˆå§‹åŒ–');
    loadLocalData();
    
    // æ·»åŠ ç­›é€‰å™¨äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('filterExchange').addEventListener('change', function() {
        displayData(window.currentData || []);
    });
    document.getElementById('filterSymbol').addEventListener('change', function() {
        displayData(window.currentData || []);
    });
    document.getElementById('filterTimeframe').addEventListener('change', function() {
        displayData(window.currentData || []);
    });
    document.getElementById('filterDataType').addEventListener('change', function() {
        displayData(window.currentData || []);
    });
});

async function loadLocalData() {
    try {
        const response = await fetch('/api/data/local-data');
        const result = await response.json();
        
        if (result.success) {
            window.currentData = result.data; // ä¿å­˜åˆ°å…¨å±€å˜é‡
            displayData(result.data);
            updateFilters(result.data);
        } else {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', result.error);
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    }
}

function displayData(data) {
    const tbody = document.getElementById('dataTable');
    tbody.innerHTML = '';
    
    // åº”ç”¨ç­›é€‰
    const filteredData = filterData(data);
    
    if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    filteredData.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.exchange.toUpperCase()}</td>
            <td>${item.symbol}</td>
            <td>${item.timeframe}</td>
            <td>${item.data_type || 'unknown'}</td>
            <td>${item.date_range.start} åˆ° ${item.date_range.end}</td>
            <td>${item.data_points.toLocaleString()}</td>
            <td>${item.file_size}</td>
            <td>${item.last_modified}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewData('${item.file_path}')">
                    ğŸ‘ï¸ æŸ¥çœ‹
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteData('${item.file_path}')">
                    ğŸ—‘ï¸ åˆ é™¤
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function filterData(data) {
    const exchangeFilter = document.getElementById('filterExchange').value;
    const symbolFilter = document.getElementById('filterSymbol').value;
    const timeframeFilter = document.getElementById('filterTimeframe').value;
    const dataTypeFilter = document.getElementById('filterDataType').value;
    
    return data.filter(item => {
        const exchangeMatch = !exchangeFilter || item.exchange === exchangeFilter;
        const symbolMatch = !symbolFilter || item.symbol === symbolFilter;
        const timeframeMatch = !timeframeFilter || item.timeframe === timeframeFilter;
        const dataTypeMatch = !dataTypeFilter || (item.data_type || 'unknown') === dataTypeFilter;
        
        return exchangeMatch && symbolMatch && timeframeMatch && dataTypeMatch;
    });
}

function updateFilters(data) {
    const exchanges = [...new Set(data.map(item => item.exchange))];
    const symbols = [...new Set(data.map(item => item.symbol))];
    const timeframes = [...new Set(data.map(item => item.timeframe))];
    const dataTypes = [...new Set(data.map(item => item.data_type || 'unknown'))];
    
    // æ›´æ–°äº¤æ˜“æ‰€ç­›é€‰
    const exchangeFilter = document.getElementById('filterExchange');
    exchangeFilter.innerHTML = '<option value="">å…¨éƒ¨</option>';
    exchanges.forEach(exchange => {
        const option = document.createElement('option');
        option.value = exchange;
        option.textContent = exchange.toUpperCase();
        exchangeFilter.appendChild(option);
    });
    
    // æ›´æ–°äº¤æ˜“å¯¹ç­›é€‰
    const symbolFilter = document.getElementById('filterSymbol');
    symbolFilter.innerHTML = '<option value="">å…¨éƒ¨</option>';
    symbols.forEach(symbol => {
        const option = document.createElement('option');
        option.value = symbol;
        option.textContent = symbol;
        symbolFilter.appendChild(option);
    });
    
    // æ›´æ–°æ—¶é—´æ¡†æ¶ç­›é€‰
    const timeframeFilter = document.getElementById('filterTimeframe');
    timeframeFilter.innerHTML = '<option value="">å…¨éƒ¨</option>';
    timeframes.forEach(timeframe => {
        const option = document.createElement('option');
        option.value = timeframe;
        option.textContent = timeframe;
        timeframeFilter.appendChild(option);
    });
    
    // æ›´æ–°æ•°æ®ç±»å‹ç­›é€‰
    const dataTypeFilter = document.getElementById('filterDataType');
    dataTypeFilter.innerHTML = '<option value="">å…¨éƒ¨</option>';
    dataTypes.forEach(dataType => {
        const option = document.createElement('option');
        option.value = dataType;
        option.textContent = dataType;
        dataTypeFilter.appendChild(option);
    });
}

function refreshData() {
    loadLocalData();
}

function viewData(filePath) {
    alert(`æŸ¥çœ‹æ•°æ®: ${filePath}\n\næ•°æ®æŸ¥çœ‹åŠŸèƒ½å¼€å‘ä¸­...`);
}

function deleteData(filePath) {
    if (confirm(`ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ•°æ®æ–‡ä»¶å—ï¼Ÿ\n${filePath}`)) {
        fetch('/api/data/delete-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ file_path: filePath })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('æ•°æ®åˆ é™¤æˆåŠŸ');
                loadLocalData();
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + result.error);
            }
        })
        .catch(error => {
            console.error('åˆ é™¤å¤±è´¥:', error);
            alert('åˆ é™¤å¤±è´¥: ' + error.message);
        });
    }
}
</script>
{% endblock %} 